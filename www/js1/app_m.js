if(1){host="acharger.ca";useTLS=true}else{host="192.168.0.20";useTLS=false}port=9001;username=null;password=null;cleansession=true;function get_this(){return{name:"Host",cid:gL.cid,did:100}}function subscribe_cs_topic(){return"WI/"+gL.cid+"/#"}function this_mob_topic(){return"MI/"+gL.cid+"/"}function login_topic(){return"MSG/LOGIN/"+gL.cid+"/"}var mqtt;var reconnectTimeout=2e3;function MQTTconnect(){mqtt=new Paho.MQTT.Client(host,port,"web_"+parseInt(Math.random()*100,10));var options={timeout:3,useSSL:useTLS,cleanSession:cleansession,onSuccess:onConnect,onFailure:function(message){dbg("Connection failed: "+message.errorMessage+"Retrying");setTimeout(MQTTconnect,reconnectTimeout)}};mqtt.onConnectionLost=onConnectionLost;mqtt.onMessageArrived=onMessageArrived;if(username!=null){options.userName=username;options.password=password}console.log("Host="+host+", port="+port+" TLS = "+useTLS+" username="+username+" password="+password);mqtt.connect(options)}function onConnect(){dbg("Connected to "+host+":"+port);mqtt.subscribe(subscribe_cs_topic(),{qos:0,invocationContext:{mid:10},onSuccess:onSubscribe});mqtt.subscribe(login_topic()+"#",{qos:0,invocationContext:{mid:11},onSuccess:onSubscribe});mqtt.subscribe(this_mob_topic()+get_this().did,{qos:0,invocationContext:{mid:12},onSuccess:onSubscribe});dbg("subscribe to 3 topics..")}function onConnectionLost(response){setTimeout(MQTTconnect,reconnectTimeout);dbg("connection lost: "+response.errorMessage+". Reconnecting")}function getIdByMid(mid){var rv="";if(!isEmpty(mid)){var x=mid.split("-");if(x.length>=2)rv=x[0]}return rv}function process_media_files(OM){var O=OM.mfiles,L,mfiles=[];if(!O)return;L=O.length;if(L>0){for(var i=0;i<L;i++){var o=O[i];if(o){mfiles.push(o)}}}return mfiles}function process_login(m,t){var s=ba2Str(m.payloadBytes);dbg("rec:"+s);var pbf,c,OL,L;pbf=new Pbf(m.payloadBytes),c=get_this();try{OL=PMsgList.read(pbf)}catch(e){var err=e}if(!OL)return;var L=OL.msgs.length;dbg("Got Login on topic:"+t+"  MsgL :"+L);if(L>0){for(var i=0;i<L;i++){var O=OL.msgs[i];var sid=getIdByMid(O.mid),sN=O.sN;if(sid!=c.did){if(O.msg=="1")addNewUser(sid,sN);else removeUser(sid)}}}}function onMessageArrived(message){var topic=message.destinationName,pbf=new Pbf(message.payloadBytes),Cp,s;var c,OL,OM,L;c=get_this();if(topic.indexOf(login_topic())!=-1){process_login(message,topic);return}try{OM=PMMsgList.read(pbf)}catch(e){var err=e}if(!OM)return;var mfiles=process_media_files(OM);OL=OM.msgs;if(!OL)return;L=OL.msgs.length;dbg("Got msg on topic:"+topic+"  MsgL :"+L);if(L>0){for(var i=0;i<L;i++){var O=OL.msgs[i];if(!O)continue;var did=O.dDID,msg_body=O.msg,sid=getIdByMid(O.mid),sN=O.sN;if(topic.indexOf(this_mob_topic())!=-1&&O.dCID==c.cid){if(did==c.did){var x=O.media_files;var ma=[],mLen=x?x.length:0;if(mLen>0&&mfiles&&mfiles.length>0){for(var i=0;i<mLen;i++){if(x[i]==mfiles[i].fname){ma.push(mfiles[i])}}}addChatMessage(msg_body,sN,ma)}else dbg("Got msg -> NOT FOR ME")}}}}function onSubscribe(obj){var mid=obj.invocationContext.mid,c=get_this();if(mid==11){_sendMsg(login_topic()+get_this().did,c.did,"1",true,true)}else if(mid==12){dbg("Subscribed to CHAT .. OK")}}function _sendMsg(topic,did,msg,retain,f_login){var lo=[],dt=(new Date).toISOString(),c=get_this(),id=c.did,destN="*",u=findUser(did);var mid=GenerateUID(id);if(u)destN=u.name;var pbf=new Pbf,mL,m,mmL;if(!f_login){mmL=PMMsgList.read(pbf)}mL=PMsgList.read(pbf);mL.msgs=[];m=PMsg.read(pbf);m.dDID=did,m.sCID=m.dCID=c.cid,m.sN=c.name,m.mT=1,m.dN=destN,m.mid=mid;m.msg=msg;mL.msgs.push(m);if(!f_login){mmL.msgs=mL;mmL.mfiles=[];PMMsgList.write(mmL,pbf)}else{PMsgList.write(mL,pbf)}var buf=pbf.finish();mqtt.send(topic,buf,1,retain)}function sendMsg(did,msg){addChatMessage(msg,get_this().name,null);var tt=this_mob_topic()+did;_sendMsg(tt,did,msg,false,false)}function getUL(){var xx=$$("chat_cb_id");return xx.getPopup().getList()}function findUser(did){var zz=getUL(),rv=null;var d=zz.data.pull;if(d){for(var k in d){var oo=d[k];if(oo&&oo.id==did){rv=oo;break}}}return rv}function addNewUser(did,sN){if(findUser(did))return;var r=getRes(did);var q={id:did,name:sN,photo:r?r.photo:null,sel:false};getUL().add(q)}function removeUser(did){getUL().remove(did)}function getMediaPayload(pref,ind,M){var rv="";var x=M[ind];if(x){var fn=x.fname;if(fn.indexOf(pref)!=-1){rv=arrayBufferToBase64(x.payload)}}return rv}function myChatImgClick(e){var ll=$$("chat_list_id"),_id,k,ii;_id=e.id;k=_id.split("_");_id=k[1];ii=ll.getItem(_id);if(k[0]=="img"){mkrwa.ui({view:"window",width:e.naturalWidth,height:e.naturalHeight,move:true,modal:true,resize:true,id:"chat_img_win",head:{view:"toolbar",cols:[{view:"label",label:"Chat Img"},{view:"icon",icon:"mdi mdi-close-circle",click:"$$('chat_img_win').close();"}]},body:{template:"<img src='"+e.src+"' />",borderless:true}}).show(e)}else if(k[0]=="voi"){if(ii){var base64string=getMediaPayload("voi",k[2],ii.media);var snd=new Audio("data:audio/mpeg;base64,"+base64string);snd.play()}}else if(k[0]=="vid"){var base64string=getMediaPayload("vid",k[2],ii.media);mkrwa.ui({view:"window",width:240,height:320,move:true,modal:true,resize:true,id:"chat_video_win",head:{view:"toolbar",cols:[{view:"label",label:"Chat Video"},{view:"icon",icon:"mdi mdi-close-circle",click:"$$('chat_video_win').close();"}]},body:{template:'<video width="240" height="320" controls> <source type="video/mp4" src="data:video/mp4;base64,'+base64string+'" ></video>'}}).show(e)}}var chat_open=false,n_msgs=0;function chat_template(obj){var M=obj.media,L=M?M.length:0;var mh="<div class='chat_container'>";mh+="<div style='height:44px;'>";mh+="<img src='/media/resImg/blank.png'  >";mh+="<span class='user_name-left'>"+obj.user+"</span>";mh+="<span class='chat_time-right'>"+getShortTime()+"</span>";mh+="</div>";mh+="<div class='chat_msg-left'>"+obj.value+"</div>";var cf="";if(L>0){for(var i=0;i<L;i++){var _id=""+obj.id+"_"+i;var fn=M[i].fname;if(fn.indexOf(".jpg")!=-1){var imgStr64=arrayBufferToBase64(M[i].payload);_id="img_"+_id;var ph="data:image/jpg;base64, "+imgStr64;cf="<img id='"+_id+"' src='"+ph+"' onclick='myChatImgClick(this)' class='right'>"}else if(fn.indexOf(".m4a")!=-1){_id="voi_"+_id;cf="<img id='"+_id+"' src='mkr_files/icons/audio_notification.png' onclick='myChatImgClick(this)' class='right'>"}else if(fn.indexOf(".mp4")!=-1){_id="vid_"+_id;cf="<img id='"+_id+"' src='mkr_files/icons/ic_video.png' onclick='myChatImgClick(this)' class='right'>"}if(cf!="")mh+=cf}}mh+="</div>";return mh}function send_message(){var txt=$$("message").getValue();$$("message").setValue("");$$("message").focus();var rid=$$("chat_cb_id").getValue();sendMsg(parseInt(rid),txt)}function addChatMessage(txt,un,ma){if(txt)$$("chat_list_id").add({user:un,value:txt,media:ma})}var chat_body={type:"clean",borderless:true,rows:[{type:"clean",cols:[{width:50,height:50,borderless:true,template:"<img id='ch_photo_id' height='32' width='32'  />"},{view:"combo",id:"chat_cb_id",label:"",width:414,borderless:true,options:{body:{data:[],template:mob_ch_fn}},on:{onChange:selectUser},placeholder:"Select User"}]},{view:"list",id:"chat_list_id",gravity:3,type:{height:"auto"},template:chat_template},{cols:[{view:"text",id:"message",placeholder:"Type message here",gravity:3},{view:"button",value:"Send",click:send_message}],type:"space",margin:4}],type:"space",margin:2};function selectUser(id){var o=getRes(id),ph,e;ph=get_m_photo(o);e=_el("ch_photo_id");if(e)e.src=ph}function setChatSts(f){var x=$$("chat_sts_id"),ic="";if(f)ic="plug";x.define("icon",ic);x.refresh()}function init_chat(){MQTTconnect();$$("msg_pop").attachEvent("onShow",function(){updateNMsgs(0);chat_open=true,n_msgs=0});$$("msg_pop").attachEvent("onHide",function(){chat_open=false,n_msgs=0});mkrwa.UIManager.addHotKey("Enter",send_message,$$("message"));mkrwa.UIManager.setFocus($$("message"))}var str_sts=["0.Open","1.Created","2.Dispatched","3.Started","4.Completed","5.Rejected"],sts_color=["black","brown","blue","green","black","red"],str_charger_type=["1.Grizzl-E Classic","2.Grizzl-E Smart","3.Grizzl-E Extreme Edition","4.Grizzl-E Avalanche Edition","5.Grizzl-E Duo","6.Alpha ","7.PCPH Set"],str_model_number=[["GR1-6-18-R","GR1-6-18-P","GR1-6-24-R","GR1-6-24-P","GR1-14-18-R","GR1-14-18-P","GR1-14-24-R","GR1-14-24-P"],["GRS-6-24-P","GRS-14-24-P"],["GR1-14-24-PC"],["GR1-14-24-PW"]];function CHSTATIONS(id){var ths=this;var tv,_id,selCS=null,cert_flag=0,my_to,fw_upl_run=0,fw_status="",fw_ver=-1;this.chs=[],this.loc=null,this.edit_wo=null;this.init=function(id){_id="tb_"+id;var cont_id=$$(id).getNode(),zz=$$("multi_id").getNode(),w,h;w=zz.clientWidth,h=zz.clientHeight;var data_list={view:"dataview",id:"data_v_id",template:ths.CSTempl,type:{width:(w-32)/4,height:440},on:{onItemClick:function(id,e,trg){var xx=$$("data_v_id"),o=xx.getItem(id),p=selCS;if(p){p.sel=0;try{xx.updateItem(p.id,p)}catch(err){}}ths.setSelected(xx,o)}},xCount:4,css:"borderless"};var wo_tb_ctrl=[{view:"button",width:120,type:"icon",icon:"mdi mdi-plus-circle-outline",label:"Add",click:ths.addNewCS},{view:"button",width:120,type:"icon",icon:"mdi mdi-circle-edit-outline",label:"Edit",click:ths.editWO},{view:"button",width:120,type:"icon",icon:"mdi mdi-delete-circle-outline",label:"Delete",click:ths.deleteWO},{view:"button",id:"b_upd_id",width:160,type:"icon",icon:"mdi mdi-cellphone-arrow-down",label:"Firmware Update",click:ths.updateFW}];mkrwa.ui({id:_id,height:h,container:cont_id,rows:[{view:"toolbar",width:w,id:"wo_tb_id",css:"highlighted_header header2",elements:wo_tb_ctrl},data_list]});ths.getVersion()};this.setSelected=function(xx,o){selCS=o;o.sel=1;xx.updateItem(o.id,o);setLbl("l_sel_cs_id",o.sern);window.setTimeout(refreshLog,2e3)};this.CSTempl=function(o){if(o.sel==1){var fwv=ths.getCsFwVer(o);if(fwv<fw_ver){ths.updBadge(fw_ver)}else ths.updBadge(0)}o.name="Grizzl-E Smart";o.model="GRS-6-24-P";var h=o.sel==1?"<div class='my_cs_main_s'>":"<div class='my_cs_main'>";h+="<div class='cslabel success'>"+o.name+"</div>";h+="<div class='cslabel info'>"+o.sern+"</div>";h+="<div class='cslabel warning'>"+o.model+"</div>";h+="<div class='cslabel warning'>FW Version: "+o.fwver+"</div>";var cn="Connected";var cls="class='cslabel ";if(o.sts==0){cn="Not "+cn;cls+="other'"}else{cls+="active'"}h+="<div "+cls+">"+cn+"</div>";var z="Idling";if(o.cs_sts){z=o.cs_sts.sts}o.publ="NO";h+="<div><span class='cslabel_1 success'>Status: </span> <span class='cslabel_2 info'>"+z+"</span></div>";h+="<div><span class='cslabel_1 success'>Public: </span> <span class='cslabel_2 info'>"+o.publ+"</span></div>";h+="</div>";return h};this.updateCSSts=function(rtt){var xx=$$("data_v_id"),wo=ths.getSelCS();xx.data.each(function(o){if(o){var l=rtt.length;for(var i=0;i<l;i++){var q=rtt[i],f=0;if(q.sern==o.sern){if(q.sts==1){o.sts=1;var v=ths.processObjB(q.objb);if(v)o.cs_sts=v;f=1}else{if(o.sts==1){o.sts=0;o.cs_sts=null;f=1}}if(o.fwver!=q.fwver){o.fwver=q.fwver;f=1}if(fw_upl_run>0){if(wo&&wo.sern==o.sern){var s1=q.ref.split(",");if(s1.length>=2){ths.processFWStatus(s1)}}}if(f)xx.updateItem(o.id,o)}}}})};this.processObjB=function(o){var s1=o.split(","),rv=null;if(s1.length>=5){return{sts:s1[1],err:s1[2],info:s1[4]}}return rv};this.updateRHB=function(o){};this.getVersion=function(){sendCommPReq(73,gL.cid,-1,gL.user,"*",function(buf){var s=ba2Str(buf);if(s&&s.length==4){fw_ver=parseInt(s)}else fw_ver=-1;ths.getCSs()})};this.getCSs=function(){sendCommPReq(40,gL.cid,-1,gL.user,"*",function(buf){var o,p=new Pbf(buf);try{o=PCSList.read(p)}catch(e){}if(o){ths.chs=o;ths.updateActs();setReportCSCombo(o)}})};this.updateActs=function(){var xx=$$("data_v_id"),woL=ths.chs.cs_items;xx.clearAll();var sn="",s_o=null;if(selCS)sn=selCS.sern;for(var i=0;i<woL.length;i++){var o=woL[i];var addr=o.Street+" , "+o.City+" , "+o.Country;var Y="YES",N="NO",rn="NA";var t1=dtMillis(o.CreatedTS),t2=o.LastUpdtdTS==0?"NA":dtMillis(o.LastUpdtdTS);var cf1=N,cf2=N,cf3=N;if(o.CertFlag>0){var cf=o.CertFlag;if(cf&1)cf1=Y;if(cf&2)cf2=Y;if(cf&4)cf3=Y}var _tt=ths.getDescByType(o.type),modN=o.Param1;var v=ths.processObjB(ba2Str(o.ObjB));var q1={id:o.ID,name:_tt,model:modN,caller:o.Caller,sts:o.status,ts1:t1,sern:o.SerialN,fwver:o.FWVer,instr:o.Instrs,ULCert:cf1,GRCert:cf2,publ:cf3,ts2:t2,rname:rn,cs_sts:v,sel:0,tz:o.tz,dls:o.dls};xx.add(q1);if(i==0&&sn==""){s_o=q1}else if(sn!=""&&q1.sern==sn){s_o=q1}}if(s_o){ths.setSelected(xx,s_o)}};this.getLastCS=function(){var woL=ths.chs.cs_items,o=null,L=woL.length;if(woL&&L>0)o=woL[L-1];return o};this.ocppCommand=function(cs,cmd,cb){if(!cs)return;sendCommPReq(65,gL.cid,cmd,cs.sern,"",function(buf){var s=ba2Str(buf);if(s){mkrwa.message("Message has been sent: "+s);if(s=="OK"){if(cb)cb()}}})};this.getSelCS=function(){if(!selCS){return null}return selCS};this.findCSBySN=function(sn){var I=ths.chs.cs_items,L=I.length,i,wo,rv=null;for(i=0;i<L;i++){wo=I[i];if(wo.SerialN==sn){rv=wo;rv.arrInd=i;break}}return rv};this.deleteCsArr=function(sn){var o=ths.findCSBySN(sn);if(o)ths.chs.cs_items.splice(o.arrInd,1)};this.deleteWO=function(){var wo=ths.getSelCS(),sn;if(!wo)return;mkrwa.confirm({text:"Are you sure you want to delete this station?",ok:"Yes",cancel:"Cancel",callback:function(res){if(res){sn=wo.sern;sendCommPReq(56,gL.cid,1,sn,"*",function(buf){var s=ba2Str(buf);if(s.indexOf("OK")!=-1){ths.deleteCsArr(sn);selCS=null;ths.updateActs()}});return false}}});return false};this.editWO=function(){};this.getLblUC=function(n,cs){if(isNDef(cs))cs=ths.getSelCS();if(!cs)return;var u,id=cs.SerialN,ts=0;u=_URL+id+".pdf";downloadFile(u+"?req="+n+"&rid="+cs.ID+"&vid="+ts+"&cid="+gL.cid+"&id="+id+"&rn="+g_rand())};this.gtLblG=function(){ths.getLblUC(13)};this.gtLblUL=function(){ths.getLblUC(14)};this.getLblG=function(cs){ths.getLblUC(13,cs)};this.getLblUL=function(cs){ths.getLblUC(14,cs)};this.getDescByType=function(t){var a=str_charger_type,rv="";for(var i=0;i<a.length;i++){var x=a[i].split(".");if(x.length>=2){if(t==parseInt(x[0])){rv=x[1];break}}}return rv};this.getTypeByDesc=function(d){var a=str_charger_type,rv=0;for(var i=0;i<a.length;i++){var x=a[i].split(".");if(x.length>=2){if(d==x[1]){rv=parseInt(x[0]);break}}}return rv};this.addNewCS=function(){ths.qr_arr=null;sendCommPReq(58,gL.cid,-1,gL.user,"*",function(buf){var s=ba2Str(buf);var rv=-1;if(s.indexOf("OK")!=-1){var x=s.split(":");if(x.length>=2)rv=parseInt(x[1])}if(rv>0){ths.doWO(null,rv+1)}else if(rv==-1){ths.doWO(null,1)}})};this.genNewSerialN=function(type,last_woid){ths.qr_arr=null;var rv=-1,s=str_charger_type[type-1];var sN="GR";if(1){sN="GRS";var hex=Number(last_woid).toString(16);sN+="-4011";switch(hex.length){case 1:sN+="00000";break;case 2:sN+="0000";break;case 3:sN+="000";break;case 4:sN+="00";break;case 5:sN+="0";break}sN+=hex;var f1=$$("wo_form1_id");var vv=f1.getValues();vv.serial_n=sN;f1.setValues(vv)}return rv};this.doWO=function(wo,last_woid){ths.edit_wo=wo;var _str_sts=[],charger_type=[],model_nmb=[],_gid=guid();for(var i=0;i<5;i++){var q={id:i+1,value:str_sts[i]};_str_sts.push(q)}for(var i=0;i<7;i++){var q={id:i+1,value:str_charger_type[i]};charger_type.push(q)}var zzz=0,lcs=ths.getLastCS();if(lcs){var type1=lcs.type-1;if(type1>=0){var vv=str_model_number[type1];for(var i=0;i<vv.length;i++){var q={id:i+1,value:vv[i]};model_nmb.push(q)}}}else{var vv=str_model_number[1];for(var i=0;i<vv.length;i++){var q={id:i+1,value:vv[i]};model_nmb.push(q)}}var fui1=[{rows:[{margin:10,cols:[{view:"text",id:"serial_n_id",width:400,name:"serial_n",label:"Serial Number",value:""}]}]}];var fui2=[{rows:[{template:"SERVICE OPTIONS",type:"section"},{cols:[{view:"datepicker",name:"ts1_n",label:"Create date",value:new Date,format:"%d  %M %Y"}]},{view:"combo",name:"cs_type_n_id",id:"cs_type_id_id",label:"Charger Type",value:lcs?lcs.type:2,options:charger_type},{view:"combo",id:"model_n_id",name:"model_n",label:"Model number:",value:lcs?lcs.serviceGroup:1,options:model_nmb},{view:"combo",name:"sts_n",value:2,label:"Status",options:_str_sts}]}];var wo_form1={view:"form",id:"wo_form1_id",padding:18,elements:fui1,rules:{$all:mkrwa.rules.isNotEmpty},elementsConfig:{labelWidth:120,labelAlign:"right"}};var wo_form2={view:"form",id:"wo_form2",padding:18,elements:fui2,rules:{$all:mkrwa.rules.isNotEmpty},elementsConfig:{labelWidth:100,labelAlign:"right"}};var qr_tmpl='<article><canvas id="qrcode-canvas" width="232" height="232" /></article>';var ui_wo_pu_body={type:"clean",cols:[{body:wo_form1}]};var wo_lbl="Add Smart Charger";if(wo)wo_lbl="Edit Smart Charger ID:"+wo.ID;var add_station_pu={view:"window",modal:true,id:"order-win",height:screen.availHeight,width:800,left:100,top:100,move:true,resize:true,css:"bradius",head:{view:"toolbar",cols:[{view:"label",label:wo_lbl},{view:"button",width:160,icon:"save",type:"iconButton",label:"Create",click:ths.SaveCS},{view:"icon",icon:"mdi mdi-close-circle",click:"$$('order-win').close();"}]},body:ui_wo_pu_body};mkrwa.ui(add_station_pu).show();var xx=$$("order-win");xx.resize();if(wo){$$("wo_form1_id").setValues({cs_type_n:ths.getDescByType(wo.type),call_n:wo.Caller,ref_n:wo.Reference,serial_n:wo.SerialN,strt_n:wo.Street,city_n:wo.City,cntr_n:wo.Country,zip_n:wo.PostalCode,prov_n:wo.Province,cert1_n:cert_flag&1,cert2_n:cert_flag&2,instr_n:wo.Instructions});$$("wo_form2").setValues({ts1_n:ts2D(wo.StartTime),model_n:wo.Param1,sts_n:str_sts[wo.status],cs_type_n_id:str_charger_type[wo.serviceGroup]});var addr=wo.Street+" , "+wo.City+" , "+wo.Country+" , "+wo.PostalCode}ths.genNewSerialN(lcs?lcs.type:2,last_woid);cert_flag=lcs?lcs.CertFlag:1};this.SaveCS=function(){var f1=$$("wo_form1_id");if(f1){var vv=f1.getValues();if(vv){if(vv.serial_n.length<3){mkrwa.alert({type:"alert-error",text:"Error: Please make sure you generated a serial number"});return}var rid=isNDef(gL.rid)?-1:gL.rid;var n=ths.edit_wo?ths.edit_wo.ID:-1,aid=n,v=n>0?52:51,pbf=new Pbf,comm=createCommP(pbf,v,gL.cid,rid,"*","*"),cll="*";_tt="Grizzl-E Smart";q={ID:n,type:_tt,Caller:cll,Reference:"*",Address:"*"};q.SerialN=vv.serial_n;q.CertFlag="1";q.Instrs="NA";q.ClientID="NA";q.Param1="GRS-6-24-P";q.CreatedTS=Date.now();q.LastUpdtdTS=0;q.serviceGroup=1;q.status=1;q.Lat=40,q.Lon=-70;q.ObjB=ths.qr_arr;PCSItem.write(q,pbf);comm.payload=pbf.finish();pbf=new Pbf;CommPacket.write(comm,pbf);var buffer=pbf.finish();sendBAPost(_url_,buffer,function(buf){var s=ba2Str(buf);if(s.indexOf("OK")!=-1){var k=s.split(":");if(aid==-1){q.ID=k[1];ths.chs.cs_items.push(q);ths.getLblUL(q)}else{var wo=ths.getSelCS();ths.chs.cs_items[wo.arrIndex]=q}ths.updateActs();$$("order-win").close()}else{mkrwa.alert({type:"alert-error",text:"Error: "+s})}})}}};this.dispose=function(){mTv.removeView(tv.id);ths.chs=[];tv=null};this.certificate=function(){var f1=$$("wo_form1_id"),f=0;if(f1){var vv=f1.getValues();if(vv.cert1_n)f|=1;if(vv.cert2_n)f|=2;cert_flag=f}};this.updComboModel=function(ind){if(ind>3)return;var xx=$$("model_n_id");var zz=xx.getPopup().getList();zz.clearAll();var vv=str_model_number[ind];for(var i=0;i<vv.length;i++){var q={id:i+1,value:vv[i]};zz.add(q)}xx.setValue(1)};this.addFwUplLog=function(s){var x=$$("log_upl_list");x.add({log:s})};this.processFWStatus=function(s1){if(fw_upl_run==0)return;var sts=s1[0],ts=s1[1];if(fw_status!=sts){fw_status=sts;if(sts=="Started"){}else if(sts=="Stage2-Start"){}else if(sts=="Installed"){fw_upl_run=0;ths.addFwUplLog(sts);ths.updateFwSts(1,"server");ths.updateFwSts(2,"server");clearTimeout(my_to);ths.addFwUplLog("Installation success. You can close it now")}else if(sts.indexOf("Failed")!=-1){fw_upl_run=0;ths.addFwUplLog(sts);ths.updateFwSts(1,"error");ths.updateFwSts(2,"error");clearTimeout(my_to);ths.addFwUplLog("Installation failure. Try again later")}}};this.updateFwSts=function(id,sts){var zz=$$("my_upl_list");var o=zz.getItem(id);o.status=sts;if(sts=="server")o.percent=100;zz.updateItem(o.id,o)};this.uploadBegCb=function(){fw_upl_run=1,fw_status="";my_to=setTimeout(ths.progressFW,1e3);ths.addFwUplLog("FW Upload Started..")};this.uploadBegin=function(){if(fw_upl_run>0){mkrwa.message("Firmware upload has already been started");return}var wo=ths.getSelCS();if(!wo)return;ths.ocppCommand(wo,12,ths.uploadBegCb);var x=$$("start_upl_id");x.define("disabled",true);x.refresh()};this.uploadEnd=function(){clearTimeout(my_to);fw_upl_run=0;$$("fw-upload-win").close()};this.progressFW=function(){var zz=$$("my_upl_list");var o=zz.getItem(fw_upl_run),to=2;if(fw_upl_run==2)to=1;var pp=o.percent+to;if(pp<=100){if(o.status=="client")o.status="transfer";o.percent=pp;zz.updateItem(o.id,o);my_to=setTimeout(ths.progressFW,1e3)}else{if(fw_upl_run==1){fw_upl_run=2;ths.updateFwSts(1,"server");ths.updateFwSts(2,"transfer");my_to=setTimeout(ths.progressFW,1e3)}}};this.doFWUpdWin=function(){mkrwa.type(mkrwa.ui.list,{name:"myUploader",template:function(f,type){var html="<div class='overall'><div class='name'>"+f.name+"</div>";html+="<div class='status'>";html+="<div class='progress "+f.status+"' style='width:"+(f.status=="transfer"||f.status=="server"?f.percent+"%":"0px")+"'></div>";html+="<div class='message "+f.status+"'>"+type.status(f)+"</div>";html+="</div>";html+="<div class='size'>"+f.sizetext+"</div></div>";return html},status:function(f){var messages={server:"Done",error:"Error",client:"Ready",transfer:f.percent+"%"};return messages[f.status]},height:35});var ui_fw_pu_body={padding:5,view:"form",type:"line",rows:[{view:"list",id:"my_upl_list",type:"myUploader",autoheight:true,minHeight:50},{template:"Do not disconnect charging station power or interrupt WiFi communication</br> during the firmware upload !!!</br>Please make sure you have a charging power cable unplugged",autoheight:true,minHeight:50},{view:"list",id:"log_upl_list",template:function(o){var h="<div style='color:blue;'>"+o.log+"</div>";return h},autoheight:true,minHeight:150}]};var fw_upd_station_pu={view:"window",modal:true,id:"fw-upload-win",height:300,width:600,left:100,top:100,move:true,resize:true,css:"bradius",head:{view:"toolbar",cols:[{view:"label",label:"Firmware upload version: "+ths.getVerStr()},{view:"button",id:"start_upl_id",width:160,icon:"save",type:"iconButton",label:"Start Upload",click:ths.uploadBegin},{view:"icon",icon:"mdi mdi-close-circle",click:ths.uploadEnd}]},body:ui_fw_pu_body};mkrwa.ui(fw_upd_station_pu).show();var zz=$$("my_upl_list");var q={id:1,name:"Upload stage 1",status:"client",percent:0,sizetext:"37 kB"};zz.add(q);q={id:2,name:"Upload stage 2",status:"client",percent:0,sizetext:"1.04 Mb"};zz.add(q)};this.getVerStr=function(){var z=y=fw_ver/100;var s=y<10?"0"+y:""+y;return s};this.getCsFwVer=function(wo){var rv=0,fw=wo.fwver,s1=[];if(!isNDef(fw)&&fw.indexOf(".")!=-1)s1=fw.split(".");if(s1.length>=2){var v1=parseInt(s1[0]);rv=v1*100+parseInt(s1[1])}return rv};this.updateFW=function(){var wo=ths.getSelCS(),fwv=0;if(!wo)return;fwv=ths.getCsFwVer(wo);if(fwv>=526){if(wo.sts==0){mkrwa.alert({type:"alert-error",text:"Your station must be connected to internet in order to upload the firmware"});return}ths.doFWUpdWin()}else{mkrwa.alert({type:"alert-error",text:"Your station firmware version must be 05.26 and greater</br> Please contact manufacturer"})}return false};this.updBadge=function(v){var x=$$("b_upd_id");x.config.badge=v>0?v:false;x.config.disabled=v>0?false:true;x.refresh()};this.init(id);return this}function getCSOcppTestUI(){var ts=new Date;var ts0=new Date;ts.setTime(ts0.getTime()+7*864e5);var cs_ocppt_item_selector={view:"form",scroll:"y",id:"cs_ocppt_id",elements:[{view:"combo",name:"cb_ocppt_cmd_n",label:"Command",value:"GetConfiguration",options:["RemoteStartTransaction","RemoteStopTransaction","GetConfiguration","GetConfiguration_1","GetLocalListVersion","ReserveNow","CancelReservation","Change-Available","Change-Unavailable","Reset","TxDefaultProfile_0","TxDefaultProfile_31","TxProfile-0.0","TxProfile-20.0","TxProfile-31.0","HB_Interval","GetCompositeSchedule"]},{view:"combo",name:"cb_ocppt_par_n",label:"Params",value:"HeartBeatInterval",options:["HeartBeatInterval","DummyTag","Soft","Hard"]},{height:40},{view:"button",type:"form",value:"Send command",inputWidth:140,align:"center",click:sendCmd,disabled:false},{height:40},{view:"button",type:"form",value:"Refresh log",inputWidth:140,align:"center",click:refreshLog},{view:"button",type:"form",value:"Clear log",inputWidth:140,align:"center",click:clearLog,disabled:false},{}],elementsConfig:{labelWidth:100,labelAlign:"left"}};var r_container={id:"ocpp_log_tbl_id",view:"datatable",select:true,scroll:"xy",margin:10,navigation:true,editable:true,css:"mkrwa_data_border mkrwa_header_border",resizeColumn:{size:10},columns:[{id:"id",header:"#",width:50},{id:"ics",header:"",width:36,template:IconTempl},{id:"o_act",header:["Ocpp Action",{content:"textFilter"}],width:120},{id:"cs_sts",header:["CS Status",{content:"textFilter"}],width:120},{id:"ts1",header:"Timestamp",width:140,sort:"string"},{id:"err_c",header:"Error Code",width:160},{id:"info",header:"Info",width:200},{id:"connid",header:"ConnectorId",width:200}],data:[],on:{onItemClick:function(id,e,trg){}}};return{id:"m_5",type:"space",cols:[{width:400,header:"Command to charge point",headerHeight:45,body:cs_ocppt_item_selector},{view:"resizer"},r_container]}}function cs_mark_sts(o){try{var st=o.sts;var s_s=str_sts[st].substring(2),cl=sts_color[st];return"<span style='color:"+cl+"'>"+s_s+"</span>"}catch(e){return"-"}}function IconTempl(o){var h="<div class='my_woicon'></div>";return h}function sendOcppCommand(sern,par,cmd){sendCommPReq(65,gL.cid,cmd,sern,par,function(buf){var s=ba2Str(buf);if(s){mkrwa.message("Message has been sent:"+s);window.setTimeout(refreshLog,3e3)}})}function getSelCSsern(){var sn=$$("l_sel_cs_id");sn=sn.config.label;if(isEmpty(sn)){mkrwa.alert({ok:"ERR",type:"alert-warning",text:"Please select charge point "});return""}return sn}function sendCmd(){var sn,f1=$$("cs_ocppt_id"),vv,s,cmd=0,par="";vv=f1.getValues();sn=getSelCSsern();s=vv.cb_ocppt_cmd_n;if(s=="GetConfiguration")cmd=14;else if(s=="GetLocalListVersion")cmd=15;else if(s.indexOf("RemoteStart")!=-1)cmd=16;else if(s.indexOf("RemoteStop")!=-1)cmd=17;else if(s=="ReserveNow")cmd=18;else if(s=="CancelReservation")cmd=19;else if(s=="Change-Available")cmd=20;else if(s=="Change-Unavailable")cmd=21;else if(s=="Reset")cmd=22;else if(s=="TxDefaultProfile_0")cmd=30;else if(s=="TxDefaultProfile_31")cmd=31;else if(s=="TxProfile-0.0")cmd=32;else if(s=="TxProfile-20.0")cmd=33;else if(s=="TxProfile-31.0")cmd=34;else if(s=="HB_Interval")cmd=35;else if(s=="GetCompositeSchedule")cmd=36;else if(s=="GetConfiguration_1")cmd=37;sendOcppCommand(sn,par,cmd)}function refreshLog(){var xx=$$("ocpp_log_tbl_id"),t1;xx.clearAll();var Cs=getSelCSsern();if(Cs=="")return;sendCommPReq(67,gL.cid,-1,Cs,"*",function(buf){var s=ba2Str(buf);if(s&&s.length>4){var hv=JSON.parse(s);if(hv){var l=hv.CsHist.length;for(var i=0;i<l;i++){var q=hv.CsHist[i];var v,c_id=1,info="NA";if(q.rtt!="*"){v=q.rtt.split(",");c_id=parseInt(v[0]);info=isEmpty(v[2])?"NA":v[2]}t1=dtMillis(q.ts);var q1={id:i+1,o_act:q.o_act,cs_sts:q.cs_sts,ts1:t1,err_c:q.err_c,info:info,connid:c_id};xx.add(q1)}}}})}function clearLog(){mkrwa.confirm({text:"Are you sure you want to clear logs for this station?",ok:"Yes",cancel:"Cancel",callback:function(res){if(res){var xx=$$("ocpp_log_tbl_id");var Cs=getSelCSsern();if(Cs=="")return;sendCommPReq(68,gL.cid,-1,Cs,"*",function(buf){var s=ba2Str(buf);if(s){if(s.indexOf("OK")!=-1){xx.clearAll();mkrwa.message(Cs+" Log has been cleared")}}});return false}}})}function getCSProfileUI(){var ts=new Date;var ts0=new Date;ts.setTime(ts0.getTime()+7*864e5);var cs_prof_item_selector={view:"form",scroll:"y",id:"cs_prof_id",elements:[{view:"label",id:"l_prof_id"},{margin:0,cols:[{view:"label",id:"l_conn_n"},{view:"label",id:"l_stackl_n"}]},{},{view:"combo",name:"rkt_prof_cb_n",value:"Weekly",label:"Recurrency",options:["Daily","Weekly"],on:{onChange:function(id){}}},{},{rows:[{template:"Charging Schedule",type:"section"},{view:"datepicker",label:"StartSchedule",name:"cs_tp_n",value:ts0,format:"%d  %M %Y  %H:%i:%s",timepicker:true,on:{onChange:function(nv,ov,c){set_dp1_dp2(nv)}}},{view:"combo",name:"ru_prof_cb_n",value:"Amperes (current)",label:"Rate unit",options:["Watts (power)","Amperes (current)"],on:{onChange:function(id){}}},{template:"Charging Period",type:"section"},{margin:0,cols:[{view:"text",name:"t_climit_id",value:"32",label:"Charge Limit:",inputAlign:"right",labelAlign:"left",inputWidth:160},{view:"text",name:"t_cdur_id",value:"1",label:"Duration:",inputAlign:"right",labelAlign:"left",inputWidth:160}]},{view:"datepicker",id:"dp_tm1",value:ts0,label:"Start Period",format:"%d  %M %H:%i:%s",timepicker:true,disabled:true},{view:"datepicker",id:"dp_tm2",value:ts0,label:"End Period",format:"%d  %M  %H:%i:%s",timepicker:true,disabled:true},{height:10},{view:"button",id:"en_new_p_btn",type:"icon",icon:"mdi mdi-plus-network-outline",label:"Add new period",inputWidth:140,align:"center",disabled:true,click:genPeriod},{}]}],elementsConfig:{labelWidth:100,labelAlign:"left"}};var r_container={type:"clean",view:"form",id:"my_cs_prof_form",scroll:"y",borderless:true,elements:[{view:"toolbar",cols:[{view:"combo",id:"profiles_cb",label:"Profiles",width:400,options:[],on:{onChange:onProfChange},placeholder:"Select station charging profile"},{type:"space"},{view:"button",width:140,type:"icon",icon:"mdi mdi-cancel",label:"Clear Profile",click:clearCSProf},{type:"space"},{view:"button",width:140,type:"icon",icon:"mdi mdi-playlist-plus",label:"Add Profile",click:newCSProf},{view:"button",width:140,type:"icon",icon:"mdi mdi-content-save-move",label:"Save Profile",click:saveCSProf}]},{view:"chart",id:"prof_chart_id",type:"line",minWidth:800,height:400,color:"#color#",xAxis:{template:"#hour#",title:"Period duration (minutes)"},yAxis:{title:"Charging current (A)",start:0,step:10,end:100},offset:0,legend:{values:[{text:"Profile A"}],align:"right",valign:"middle",layout:"y",width:100,margin:8,marker:{type:"item",width:18}},series:[{value:"#prof1#",item:{borderColor:"#447900",color:"#69ba00"},line:{color:"#color#",width:2},tooltip:{template:"#prof1#"}}],data:[]},{},{view:"checkbox",id:"cs_prof_cb1",value:0,labelWidth:400,labelAlign:"right",label:"Assign this profile to all stations"},{view:"checkbox",id:"cs_prof_cb2",value:1,labelWidth:400,labelAlign:"right",label:"Assign this profile to the selected station"},{},{template:"Time zone settings",type:"section"},{margin:2,cols:[{view:"combo",id:"utc_off_cb",label:"Time zone",width:400,options:[{id:-4,value:"(UTC-04)Atlantic Time(US & Canada)"},{id:-5,value:"(UTC-05)Eastern Time(US & Canada)"},{id:-6,value:"(UTC-06)Central Time(US & Canada)"},{id:-7,value:"(UTC-07)Mountain Time(US & Canada)"},{id:-8,value:"(UTC-08)Pacific Time(US & Canada)"}],on:{onChange:function(id){}},placeholder:"Select station time zone"},{view:"checkbox",id:"cs_dls_cb",labelWidth:120,labelAlign:"right",label:"Daylight savings"},{view:"button",id:"tz_upd_btn",type:"icon",icon:"mdi mdi-earth",label:"Update",inputWidth:100,align:"center",click:saveTZ}]},{}]};return{id:"m_4",type:"space",cols:[{width:400,header:"Charging Profile Setup",headerHeight:45,body:cs_prof_item_selector},{view:"resizer"},r_container]}}function saveTZ(){var G=gCHO,tzV=$$("utc_off_cb").getValue(),dls=$$("cs_dls_cb").getValue(),utcOff=20,cs,sn;if(!G)return;cs=G.getSelCS();if(!cs||cs.sts==0){mkrwa.alert({type:"alert-error",text:"Your station must be connected to internet"});return}utcOff=tzV;sn=cs.sern;if(!isEmpty(sn)&&utcOff!=20){var pbf=new Pbf,comm=createCommP(pbf,41,gL.cid,11,sn,"*"),q;q={utcOff:utcOff,dls:dls};PConf.write(q,pbf);comm.payload=pbf.finish();pbf=new Pbf;CommPacket.write(comm,pbf);var buffer=pbf.finish();sendBAPost(_url_,buffer,function(buf){var s=ba2Str(buf);if(s.indexOf("OK")!=-1){mkrwa.message("Time zone has been updated")}})}else{mkrwa.message("Please select the station")}}function fakeProfChartData(){var x=$$("prof_chart_id");x.clearAll()}function genPeriod(){var x=$$("dp_tm1"),x1=$$("dp_tm2"),v,v1,ts1,d_t,xx=$$("prof_chart_id"),dur,f1=$$("cs_prof_id"),vv=f1.getValues();v=x.getValue(),v1=x1.getValue();var count=xx.count();if(v&&v1){ts1=ISOStr2Date(v1.toISOString()).getTime();dur=parseInt(vv.t_cdur_id)*60*60*1e3;if(1){d_t=dur;if(d_t>0){x.setValue(new Date(ts1));x1.setValue(new Date(ts1+d_t));var min=m_round(d_t/(60*1e3));var V=vv.t_climit_id;var id=xx.getLastId();if(!isNDef(id)){var item=xx.getItem(id),h=item.hour;if(V!=item.prof1){xx.add({prof1:V,hour:h,color:"#0000ff"})}h=h+min;xx.add({prof1:V,hour:h,color:"#ffffff"})}else{xx.add({prof1:V,hour:0,color:"#0000ff"});xx.add({prof1:V,hour:min,color:"#ffffff"})}}}}}function saveCSProf(){var xx=$$("prof_chart_id"),f1=$$("cs_prof_id"),vv;vv=f1.getValues();var n=$$("l_prof_id");n=n.config.label;var k=n.split(":");n=k[1];if(isEmpty(n)){mkrwa.alert({ok:"OK",type:"alert-warning",text:"ProfileID empty. Click <New Profile> to generate one"});return}if(vv){var CP={},pID=parseInt(n);CP.connectorId=1;var cpf={};cpf.chargingProfileId=pID;cpf.chargingProfileKind="Relative";cpf.chargingProfilePurpose="TxDefaultProfile";cpf.recurrencyKind=vv.rkt_prof_cb_n;cpf.stackLevel=1;cpf.transactionId=0;cpf.validFrom="";cpf.validTo="";var csd={};csd.chargingRateUnit=vv.ru_prof_cb_n.indexOf("Amperes")!=-1?"A":"W";csd.duration=0;csd.minChargingRate=1;csd.startSchedule=mtoISOString(vv.cs_tp_n);var pp=[],p0,L=xx.count();for(var i=0;i<L;i++){var p={};var id=xx.getIdByIndex(i);var item=xx.getItem(id);p.limit=parseInt(item.prof1);p.startPeriod=item.hour;p.numberPhases=1;if(i==0){pp.push(p)}else{if(p.limit!=p0.limit){pp.push(p)}if(i==L-1){pp.push(p)}}p0=p}csd.chargingSchedulePeriod=pp;cpf.chargingSchedule=csd;CP.csChargingProfiles=cpf;var json=JSON.stringify(CP);if(json){var U="Profile_"+pID,zz,sn;zz=$$("cs_prof_cb1").getValue();if(zz)U="*|"+U;else{zz=$$("cs_prof_cb2").getValue();if(zz){sn=getSelCSsern();if(!isEmpty(sn))U=sn+"|"+U}}sendCommPReq(63,gL.cid,pID,U,json,function(buf){var s=ba2Str(buf);if(s){if(s.indexOf("OK")!=-1){var k=s.split(":");if(k[1]=="1"){mkrwa.alert({type:"alert-warning",text:"Profile has been saved"});enableCtl("en_new_p_btn",true)}}}})}}}function enableCtl(n,f){var x=$$(n);x.config.disabled=f;x.refresh()}function clearCSProf(){var sn=getSelCSsern();if(isEmpty(sn))return;sendCommPReq(69,gL.cid,-1,sn,"?",function(buf){var s=ba2Str(buf);if(s){if(s.indexOf("OK")!=-1){mkrwa.message("Charging Profile has been removed");getCsProfile()}}})}function newCSProf(){fakeProfChartData();set_dp1_dp2();sendCommPReq(63,gL.cid,-1,"*","?",function(buf){var s=ba2Str(buf);if(s){if(s.indexOf("OK")!=-1){var k=s.split(":");setLbl("l_prof_id","ProfileID: "+k[1]);setLbl("l_conn_n","ConnectorID: "+1);enableCtl("en_new_p_btn",false)}}})}function onProfChange(id){var xx=$$("profiles_cb"),zz,v;zz=xx.getPopup().getList();v=zz.getItem(id).value;if(!isEmpty(v))sendCommPReq(72,gL.cid,-1,v,"*",function(buf){profileResponse(buf)})}function updateTZ(){var G=gCHO,cs,v;if(!G)return;cs=G.getSelCS();if(!cs)return;$$("cs_dls_cb").setValue(cs.dls);var x=$$("utc_off_cb");x.setValue(cs.tz)}function clearProfCont(){setLbl("l_prof_id","ProfileID: "+0);setLbl("l_conn_n","ConnectorID: "+0);var xx=$$("prof_chart_id");xx.clearAll()}function set_dp1_dp2(ssv){if(isNDef(ssv)){var f1=$$("cs_prof_id"),vv;vv=f1.getValues();ssv=vv.cs_tp_n}var x=$$("dp_tm1"),x1=$$("dp_tm2");x.setValue(ssv),x1.setValue(ssv)}function profileResponse(buf){var s=ba2Str(buf),rv=0;if(s!="*"){var CP=JSON.parse(s),cpf,csd,pp,ppL,p,p0=null,xx=$$("prof_chart_id"),f1=$$("cs_prof_id");if(CP){cpf=CP.csChargingProfiles;setLbl("l_prof_id","ProfileID: "+cpf.chargingProfileId);setLbl("l_conn_n","ConnectorID: "+CP.connectorId);csd=cpf.chargingSchedule;pp=csd.chargingSchedulePeriod;ppL=pp.length;var ssv=ISOStr2Date(csd.startSchedule);f1.setValues({rkt_prof_cb_n:cpf.recurrencyKind,cs_tp_n:ssv,ru_prof_cb_n:csd.chargingRateUnit=="W"?"Watts (power)":"Amperes (current)"});set_dp1_dp2(ssv);xx.clearAll();for(var i=0;i<ppL;i++){p=pp[i];if(p0){xx.add({prof1:p0.limit,hour:p.startPeriod,color:"#ffffff"})}xx.add({prof1:p.limit,hour:p.startPeriod,color:"#0000ff"});p0=p}rv=1}}return rv}function getCsProfile(){updateTZ();var sn=getSelCSsern();if(isEmpty(sn))return;sendCommPReq(64,gL.cid,-1,sn,"*",function(buf){if(!profileResponse(buf)){mkrwa.message("No Profile found for station:"+sn);clearProfCont()}})}function getAllProfiles(){sendCommPReq(71,gL.cid,-1,"*","*",function(buf){var s=ba2Str(buf);if(s!="*"){var v=s.split(","),L=v.length;if(L>0){var combo=$$("profiles_cb"),o;var list=combo.getPopup().getList();list.clearAll();for(var i=0;i<L;i++){o=v[i];if(!isEmpty(o)){var q={id:i+1,value:o};list.add(q)}}}}})}var gOR;function getCSReportsUI(){var ts=new Date;var ts0=new Date;ts0.setTime(ts0.getTime()-1*864e5);var cs_rep_item_selector={width:360,type:"clean",rows:[{id:"cs_rep_list_id",view:"list",template:function(o){var h="<DIV>";h+="<DIV class='report_info'>";h+="<DIV><SPAN>SN:</SPAN>"+o.sn+"</DIV>";h+="<DIV><SPAN>TransactionId:</SPAN>"+o.trid+"</DIV>";h+="<DIV><SPAN>connectorId:</SPAN>"+o.connid+"</DIV>";h+="</DIV>";h+="<DIV class='report_info'>";h+="<DIV><SPAN>Start:</SPAN>"+dtMillis(o.ts0)+"</DIV>";h+="<DIV><SPAN></SPAN>"+"***"+"</DIV>";h+="<DIV><SPAN>End:</SPAN>"+dtMillis(o.ts1)+"</DIV>";h+="</DIV>";h+="</DIV>";return h},select:true,on:{onItemClick:function(id,e,trg){var xx=$$("cs_rep_list_id"),o=xx.getItem(id);if(o){showMeterValues(o)}}},type:{height:84}},{view:"form",elements:[{type:"clean",cols:[{width:50,height:40,borderless:true,template:"<img id='veh_photo_id' height='32' width='32'  />"},{view:"combo",id:"cs_rep_cb_id",label:"",options:{body:{data:[],template:function(o){var ph="media/v_img/chargestation.png";var cf="<img height='32' width='32' src='"+ph+"' style='float:left;'>";var h="<span style='margin-left:10px'>"+o.sn+"</span>";return"<div>"+cf+h+"</div>"}}},on:{onChange:function(id){ths_onCSSelected(id)}},placeholder:"Select charge station"}]},{view:"datepicker",label:"From",value:ts0,format:"%d  %M %Y"},{view:"datepicker",id:"cs_rep_datepicker1",label:"From",value:new Date,format:"%d  %M %Y",hidden:true},{view:"datepicker",label:"To",value:ts,format:"%d  %M %Y"},{view:"datepicker",id:"cs_rep_datepicker2",label:"To",value:new Date,format:"%d  %M %Y",hidden:true},{view:"checkbox",id:"cs_rep_flexible",value:0,label:"Last 14 days"},{height:10},{view:"button",type:"form",value:"Get Report",inputWidth:140,align:"center",click:getReports},{}],elementsConfig:{labelWidth:100,labelAlign:"left"}}]};var r_container={type:"clean",view:"form",id:"my_cs_report_form",scroll:"y",borderless:true,elements:[{view:"toolbar",cols:[{type:"space"},{view:"button",width:140,type:"iconButton",icon:"mdi mdi-file-pdf",label:"Generate report"}]},{view:"chart",id:"report_chart_id",type:"line",minWidth:800,height:400,xAxis:{template:"#hour#",title:"Time stamp",start:0,step:60,end:1440},yAxis:{title:"Charging current (A) and Power(kW)",start:0,step:10,end:50},offset:0,legend:{values:[{text:"Current A"},{text:"Power kW"}],align:"right",valign:"middle",layout:"y",width:100,margin:8,marker:{type:"item",width:18}},series:[{value:"#current#",item:{borderColor:"#447900",color:"#69ba00"},line:{color:"#69ba00",width:2},tooltip:{template:"#current#"}},{value:"#power#",item:{borderColor:"#0a796a",color:"#4aa397",type:"s",radius:4},line:{color:"#4aa397",width:2},tooltip:{template:"#power#"}}],data:[]},{template:"Charging Session Information",type:"section"},{margin:0,cols:[{view:"text",name:"t_start_id",label:"Start time:",inputAlign:"right",labelAlign:"left",labelWidth:150,inputWidth:320},{view:"text",name:"t_end_id",label:"End Time:",inputAlign:"right",labelAlign:"left",labelWidth:150,inputWidth:320}]},{margin:0,cols:[{view:"text",name:"t_nums_id",label:"Number of samples:",inputAlign:"right",labelAlign:"left",labelWidth:150,inputWidth:320},{view:"text",name:"t_cdur_id",label:"Duration:",inputAlign:"right",labelAlign:"left",labelWidth:150,inputWidth:320}]},{margin:0,cols:[{view:"text",name:"t_avpwr_id",label:"Average power:",inputAlign:"right",labelAlign:"left",labelWidth:150,inputWidth:320},{view:"text",name:"t_energy_id",label:"Energy consumed:",inputAlign:"right",labelAlign:"left",labelWidth:150,inputWidth:320}]}]};var cs_reports={id:"m_2",type:"space",cols:[{width:400,header:"Charge Station Reports",headerHeight:45,body:cs_rep_item_selector},{view:"resizer"},r_container]};return cs_reports}function updateRptTbl(zz,o){var O=o.tdlist,L=O.length,i,j,k,n,trdata;for(i=0;i<L;i++){trdata=O[i];var MV=trdata.mvalues,L1=MV.length,V0,V1,ts0,ts1;V0=MV[0],V1=MV[L1-1];ts0=V0.transactionData[0].timestamp;ts1=V1.transactionData[0].timestamp;var q1={id:i+1,sn:trdata.sern,trid:trdata.transId,connid:trdata.connId,ts0:ts0,ts1:ts1};zz.add(q1)}}function ths_onCSSelected(id){var xx=$$("cs_rep_cb_id"),zz,it;zz=xx.getPopup().getList();it=zz.getItem(id);getReports(it.sn);var ph="media/v_img/chargestation.png",e;e=_el("veh_photo_id");if(e)e.src=ph}function setReportCSCombo(O){var combo=$$("cs_rep_cb_id"),woL=O.cs_items,o;var list=combo.getPopup().getList();list.clearAll();for(var i=0;i<woL.length;i++){o=woL[i];var q={id:i+1,sn:o.SerialN};list.add(q)}}function getReports(cs){var zz=$$("cs_rep_list_id");zz.clearAll();var Cs=cs=="$button1"?getSelCSsern():cs;if(Cs=="")return;sendCommPReq(70,gL.cid,-1,Cs,"*",function(buf){var o,p=new Pbf(buf);try{o=TrDataList.read(p)}catch(e){}if(o){gOR=o;updateRptTbl(zz,o)}})}function getTransdataById(id){var O=gOR.tdlist,L=O.length,i,j,k,n,trdata;for(i=0;i<L;i++){trdata=O[i];if(trdata.transId==id){return trdata.mvalues}}return null}function showMeterValues(o){var MV=getTransdataById(o.trid),i,V,L1,sv,v,cur,pwr,sumPwr=0,pwr_h=0,d_ts=0,U=232.32,n1,xx=$$("report_chart_id");if(MV){xx.clearAll();L1=MV.length;n1=Math.floor(L1/20);for(i=0;i<L1;i++){V=MV[i].transactionData[0];sv=V.sampledValue;v=sv[0].value;if(v.indexOf(".")==-1){cur=parseInt(v)/100}else{var z=parseFloat(v);if(!isNaN(z))cur=z;else cur=0}pwr=U*cur/1e3;sumPwr+=pwr;d_ts=120;pwr_h+=pwr*d_ts/3600;if(i%n1==0||i==L1-1)xx.add({current:cur,power:pwr,hour:i})}}var f1=$$("my_cs_report_form");f1.setValues({t_start_id:dtMillis(o.ts0),t_end_id:dtMillis(o.ts1),t_nums_id:L1,t_cdur_id:ConvertMinutesToHoursandMinutes(2*L1),t_avpwr_id:m_round(sumPwr/L1,2)+" kW",t_energy_id:m_round(pwr_h,2)+" kWh"})}var th_chart={view:"chart",id:"th_chart_id",type:"line",offset:0,yAxis:{},xAxis:{lines:true,template:"'#ind#"},legend:{layout:"x",width:100,align:"right",valign:"top",values:[{text:"Charging Voltage",color:"#61b5ee"},{text:"Charging Current",color:"#e9df40"}]},series:[{type:"line",value:"#v_T#",item:{borderColor:"#fff",color:"#61b5ee",radius:4},line:{color:"#e9df40",width:2}},{type:"line",value:"#v_H#",item:{borderColor:"#fff",color:"#61b5ee",radius:4},line:{color:"#61b5ee",width:2}}],data:[]};var energy_consume_bar={id:"energy_consume_bar_id",view:"chart",type:"bar",value:"#eval#",label:"#eval#",color:"#ecolor#",radius:0,barWidth:40,tooltip:{template:"#eval#"},xAxis:{template:"#evname#",lines:false},padding:{left:10,right:10,top:50},data:[]};var aux_chart1={view:"chart",id:"aux_chart1",type:"line",xAxis:{template:"#ind1#"},yAxis:{start:0,end:100,step:20},offset:false,series:[{value:"#aux1_val#",item:{borderColor:"#fff",color:"#61b5ee",radius:4},line:{color:"#61b5ee",width:1}}],padding:{top:25},data:[]};var aux_chart2={view:"chart",id:"aux_chart2",type:"line",xAxis:{template:"#ind2#"},yAxis:{start:0,end:100,step:20},offset:false,series:[{value:"#aux2_val#",item:{borderColor:"#fff",color:"#61b5ee",radius:4},line:{color:"#61b5ee",width:1}}],padding:{top:25},data:[]};var station_usage={id:"station_usage_id",view:"chart",type:"bar",value:"#val#",label:"#val#",color:"#color#",radius:0,barWidth:40,tooltip:{template:"#val#"},xAxis:{template:"'#vname#",lines:false},padding:{left:10,right:10,top:50},data:[]};var cs_status_dataset=[{sales:"70",month:"In use",color:"#ee3639"},{sales:"30",month:"Available",color:"#ee9e36"},{sales:"20",month:"Not ready",color:"#eeea36"},{sales:"10",month:"Watch list",color:"#a9ee36"},{sales:"15",month:"Needs service",color:"#36d3ee"},{sales:"22",month:"Reserved",color:"#367fee"},{sales:"5",month:"Faulty",color:"#9b36ee"}];var station_status_pie={id:"station_status_pie_id",view:"chart",type:"pie3D",value:"#sales#",color:"#color#",label:"#month#",pieInnerText:"#sales#",shadow:0,radius:100,legend:{layout:"y",width:100,align:"right",valign:"top",values:[{text:"In use",color:"#ee3639"},{text:"Available",color:"#ee9e36"},{text:"Not ready",color:"#eeea36"},{text:"Watch list",color:"#a9ee36"},{text:"Needs srv",color:"#36d3ee"},{text:"Reserved",color:"#367fee"},{text:"Faulty",color:"#9b36ee"}]},data:cs_status_dataset};var station_usage_ext2={id:"station_usage_ext2_id",view:"chart",type:"bar",value:"#val_ext2#",label:"#val_ext2#",color:"#color_ext2#",radius:0,barWidth:40,tooltip:{template:"#val_ext2#"},xAxis:{template:"'#vname_ext2#",lines:false},padding:{left:10,right:10,top:50},data:[]};var col_station_status={type:"clean",rows:[{template:"<div><div class='chart_title'><span>Station Status</span></div><div class='chart_help'><span class='mkrwa_icon mdi mdi-help-circle-outline' /></div></div>",height:40},station_status_pie]};var dashboard_charts={id:"m_0",margin:10,rows:[{},{template:"<h1>This page is under active development</h1>"},{}]};var c_ind=1;function addWithCheck(s,v,i){}function updScale(n,v){var x=$$(n);x.define({yAxis:{start:0,end:v,step:(v/5).toFixed()}});x.refresh()}function updScaleB(n,v){var x=$$(n);x.define({yAxis:{start:0,end:v,step:(v/5).toFixed(),color:"#ffffff",lineColor:"#ffffff",template:function(value){return""}}});x.refresh()}function updateChart(d,a){var co2_exist=1;var cf=a.dconf.config,tn="T (°C)",cr,t,rh,flag,v,C,V,x;cr=cf.corr;t=-39.66+.01*d.mT1,rh=-2.0468+.0367*d.mH1+-1.5955*1e-6*d.mH1*d.mH1,flag=cf.ip_flag;t-=4;t+=cr.temp;if(flag&8){tn="T (°F)";t=toFar(t)}rh+=cr.hum;rh+=10;v={v_T:t,v_H:rh,ind:c_ind};addWithCheck("th_chart_id",v);C=(d.CO2*2.425+cr.CO2).toFixed();V=d.TGS+cr.VOC;var range1=cf.ext1_sensor.max_value-cf.ext1_sensor.min_value;var ozf=flag&128,aff=flag&256,metric=flag&512,aux1_n=cf.ext1_sensor.sensor_name+" ( "+cf.ext1_sensor.sensor_unit+" )";aux1=d.aux1*1*range1/1024,aux2_n="Ext2 ( % )",aux2=d.aux2*1*cf.aux2_range/1024;aux1+=cr.Oz;aux2+=cr.CO;updScale("aux_chart1",range1);if(aff>0){aux2_n="Air flow (CFM)";if(metric>0)aux2_n="Air flow (CMH)"}if(cf.version>192){if((flag&16)==0){C=0;co2_exist=0}if((flag&32)==0){aux1=0;aux1_n=""}if((flag&64)==0){aux2=0;aux2_n=""}}else{var copt=a.dconf.sensor_options;if((copt&1)==0){C=0;co2_exist=0}if((copt&2)==0){aux1=0;aux1_n=""}if((copt&4)==0){aux2=0;aux2_n=""}}v={voc_v:V,co2_v:C,ind:c_ind};addWithCheck("energy_consume_id",v);c_ind++;x=$$("station_usage_id");x.clearAll();t=78;x.add({id:1,val:t.toFixed(),vname:"Very light",color:"#ee4339"});t=67;x.add({id:2,val:t.toFixed(),vname:"Light",color:"#ee9336"});t=22;x.add({id:3,val:t,vname:"Moderate",color:"#eed236"});t=12;x.add({id:4,val:t,vname:"Heavy",color:"#d3ee36"});updScaleB("station_status_pie_id",cf.aux1_range);updScaleB("station_usage_ext2_id",cf.aux2_range);x=$$("station_status_pie_id");x.clearAll();var _ext1=aux1.toFixed();if(_ext1<=1)_ext1=0;x.add({id:1,val_ext1:_ext1,vname_ext1:aux1_n,color_ext1:"#a7ee70"});x=$$("station_usage_ext2_id");x.clearAll();x.add({id:1,val_ext2:aux2.toFixed(),vname_ext2:aux2_n,color_ext2:"#58dccd"})}function cleanUpDB(){$$("th_chart_id").clearAll();$$("energy_consume_id").clearAll();$$("aux_chart1").clearAll();$$("aux_chart2").clearAll();$$("station_usage_id").clearAll();$$("station_status_pie").clearAll();$$("station_usage_ext2_id").clearAll();c_ind=1}function switchUpDB(aa){cleanUpDB();if(aa&&aa.dataArr){var len=aa.dataArr.length,i;if(len>0){for(i=0;i<len;i++){updateChart(aa.dataArr[i],aa)}c_ind=i}}}function fakeDBData(){}if(typeof Paho==="undefined"){Paho={}}Paho.MQTT=function(global){var version="@VERSION@";var buildLevel="@BUILDLEVEL@";var MESSAGE_TYPE={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14};var validate=function(obj,keys){for(var key in obj){if(obj.hasOwnProperty(key)){if(keys.hasOwnProperty(key)){if(typeof obj[key]!==keys[key])throw new Error(format(ERROR.INVALID_TYPE,[typeof obj[key],key]))}else{var errorStr="Unknown property, "+key+". Valid properties are:";for(var key in keys)if(keys.hasOwnProperty(key))errorStr=errorStr+" "+key;throw new Error(errorStr)}}}};var scope=function(f,scope){return function(){return f.apply(scope,arguments)}};var ERROR={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."}};var CONNACK_RC={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"};var format=function(error,substitutions){var text=error.text;if(substitutions){var field,start;for(var i=0;i<substitutions.length;i++){field="{"+i+"}";start=text.indexOf(field);if(start>0){var part1=text.substring(0,start);var part2=text.substring(start+field.length);text=part1+substitutions[i]+part2}}}return text};var MqttProtoIdentifierv3=[0,6,77,81,73,115,100,112,3];var MqttProtoIdentifierv4=[0,4,77,81,84,84,4];var WireMessage=function(type,options){this.type=type;for(var name in options){if(options.hasOwnProperty(name)){this[name]=options[name]}}};WireMessage.prototype.encode=function(){var first=(this.type&15)<<4;var remLength=0;var topicStrLength=new Array;var destinationNameLength=0;if(this.messageIdentifier!=undefined)remLength+=2;switch(this.type){case MESSAGE_TYPE.CONNECT:switch(this.mqttVersion){case 3:remLength+=MqttProtoIdentifierv3.length+3;break;case 4:remLength+=MqttProtoIdentifierv4.length+3;break}remLength+=UTF8Length(this.clientId)+2;if(this.willMessage!=undefined){remLength+=UTF8Length(this.willMessage.destinationName)+2;var willMessagePayloadBytes=this.willMessage.payloadBytes;if(!(willMessagePayloadBytes instanceof Uint8Array))willMessagePayloadBytes=new Uint8Array(payloadBytes);remLength+=willMessagePayloadBytes.byteLength+2}if(this.userName!=undefined)remLength+=UTF8Length(this.userName)+2;if(this.password!=undefined)remLength+=UTF8Length(this.password)+2;break;case MESSAGE_TYPE.SUBSCRIBE:first|=2;for(var i=0;i<this.topics.length;i++){topicStrLength[i]=UTF8Length(this.topics[i]);remLength+=topicStrLength[i]+2}remLength+=this.requestedQos.length;break;case MESSAGE_TYPE.UNSUBSCRIBE:first|=2;for(var i=0;i<this.topics.length;i++){topicStrLength[i]=UTF8Length(this.topics[i]);remLength+=topicStrLength[i]+2}break;case MESSAGE_TYPE.PUBREL:first|=2;break;case MESSAGE_TYPE.PUBLISH:if(this.payloadMessage.duplicate)first|=8;first=first|=this.payloadMessage.qos<<1;if(this.payloadMessage.retained)first|=1;destinationNameLength=UTF8Length(this.payloadMessage.destinationName);remLength+=destinationNameLength+2;var payloadBytes=this.payloadMessage.payloadBytes;remLength+=payloadBytes.byteLength;if(payloadBytes instanceof ArrayBuffer)payloadBytes=new Uint8Array(payloadBytes);else if(!(payloadBytes instanceof Uint8Array))payloadBytes=new Uint8Array(payloadBytes.buffer);break;case MESSAGE_TYPE.DISCONNECT:break;default:;}var mbi=encodeMBI(remLength);var pos=mbi.length+1;var buffer=new ArrayBuffer(remLength+pos);var byteStream=new Uint8Array(buffer);byteStream[0]=first;byteStream.set(mbi,1);if(this.type==MESSAGE_TYPE.PUBLISH)pos=writeString(this.payloadMessage.destinationName,destinationNameLength,byteStream,pos);else if(this.type==MESSAGE_TYPE.CONNECT){switch(this.mqttVersion){case 3:byteStream.set(MqttProtoIdentifierv3,pos);pos+=MqttProtoIdentifierv3.length;break;case 4:byteStream.set(MqttProtoIdentifierv4,pos);pos+=MqttProtoIdentifierv4.length;break}var connectFlags=0;if(this.cleanSession)connectFlags=2;if(this.willMessage!=undefined){connectFlags|=4;connectFlags|=this.willMessage.qos<<3;if(this.willMessage.retained){connectFlags|=32}}if(this.userName!=undefined)connectFlags|=128;if(this.password!=undefined)connectFlags|=64;byteStream[pos++]=connectFlags;pos=writeUint16(this.keepAliveInterval,byteStream,pos)}if(this.messageIdentifier!=undefined)pos=writeUint16(this.messageIdentifier,byteStream,pos);switch(this.type){case MESSAGE_TYPE.CONNECT:pos=writeString(this.clientId,UTF8Length(this.clientId),byteStream,pos);if(this.willMessage!=undefined){pos=writeString(this.willMessage.destinationName,UTF8Length(this.willMessage.destinationName),byteStream,pos);pos=writeUint16(willMessagePayloadBytes.byteLength,byteStream,pos);byteStream.set(willMessagePayloadBytes,pos);pos+=willMessagePayloadBytes.byteLength}if(this.userName!=undefined)pos=writeString(this.userName,UTF8Length(this.userName),byteStream,pos);if(this.password!=undefined)pos=writeString(this.password,UTF8Length(this.password),byteStream,pos);break;case MESSAGE_TYPE.PUBLISH:byteStream.set(payloadBytes,pos);break;case MESSAGE_TYPE.SUBSCRIBE:for(var i=0;i<this.topics.length;i++){pos=writeString(this.topics[i],topicStrLength[i],byteStream,pos);byteStream[pos++]=this.requestedQos[i]}break;case MESSAGE_TYPE.UNSUBSCRIBE:for(var i=0;i<this.topics.length;i++)pos=writeString(this.topics[i],topicStrLength[i],byteStream,pos);break;default:}return buffer};function decodeMessage(input,pos){var startingPos=pos;var first=input[pos];var type=first>>4;var messageInfo=first&=15;pos+=1;var digit;var remLength=0;var multiplier=1;do{if(pos==input.length){return[null,startingPos]}digit=input[pos++];remLength+=(digit&127)*multiplier;multiplier*=128}while((digit&128)!=0);var endPos=pos+remLength;if(endPos>input.length){return[null,startingPos]}var wireMessage=new WireMessage(type);switch(type){case MESSAGE_TYPE.CONNACK:var connectAcknowledgeFlags=input[pos++];if(connectAcknowledgeFlags&1)wireMessage.sessionPresent=true;wireMessage.returnCode=input[pos++];break;case MESSAGE_TYPE.PUBLISH:var qos=messageInfo>>1&3;var len=readUint16(input,pos);pos+=2;var topicName=parseUTF8(input,pos,len);pos+=len;if(qos>0){wireMessage.messageIdentifier=readUint16(input,pos);pos+=2}var message=new Paho.MQTT.Message(input.subarray(pos,endPos));if((messageInfo&1)==1)message.retained=true;if((messageInfo&8)==8)message.duplicate=true;message.qos=qos;message.destinationName=topicName;wireMessage.payloadMessage=message;break;case MESSAGE_TYPE.PUBACK:case MESSAGE_TYPE.PUBREC:case MESSAGE_TYPE.PUBREL:case MESSAGE_TYPE.PUBCOMP:case MESSAGE_TYPE.UNSUBACK:wireMessage.messageIdentifier=readUint16(input,pos);break;case MESSAGE_TYPE.SUBACK:wireMessage.messageIdentifier=readUint16(input,pos);pos+=2;wireMessage.returnCode=input.subarray(pos,endPos);break;default:;}return[wireMessage,endPos]}function writeUint16(input,buffer,offset){buffer[offset++]=input>>8;buffer[offset++]=input%256;return offset}function writeString(input,utf8Length,buffer,offset){offset=writeUint16(utf8Length,buffer,offset);stringToUTF8(input,buffer,offset);return offset+utf8Length}function readUint16(buffer,offset){return 256*buffer[offset]+buffer[offset+1]}function encodeMBI(number){var output=new Array(1);var numBytes=0;do{var digit=number%128;number=number>>7;if(number>0){digit|=128}output[numBytes++]=digit}while(number>0&&numBytes<4);return output}function UTF8Length(input){var output=0;for(var i=0;i<input.length;i++){var charCode=input.charCodeAt(i);if(charCode>2047){if(55296<=charCode&&charCode<=56319){i++;output++}output+=3}else if(charCode>127)output+=2;else output++}return output}function stringToUTF8(input,output,start){var pos=start;for(var i=0;i<input.length;i++){var charCode=input.charCodeAt(i);if(55296<=charCode&&charCode<=56319){var lowCharCode=input.charCodeAt(++i);if(isNaN(lowCharCode)){throw new Error(format(ERROR.MALFORMED_UNICODE,[charCode,lowCharCode]))}charCode=(charCode-55296<<10)+(lowCharCode-56320)+65536}if(charCode<=127){output[pos++]=charCode}else if(charCode<=2047){output[pos++]=charCode>>6&31|192;output[pos++]=charCode&63|128}else if(charCode<=65535){output[pos++]=charCode>>12&15|224;output[pos++]=charCode>>6&63|128;output[pos++]=charCode&63|128}else{output[pos++]=charCode>>18&7|240;output[pos++]=charCode>>12&63|128;output[pos++]=charCode>>6&63|128;output[pos++]=charCode&63|128}}return output}function parseUTF8(input,offset,length){var output="";var utf16;var pos=offset;while(pos<offset+length){var byte1=input[pos++];if(byte1<128)utf16=byte1;else{var byte2=input[pos++]-128;if(byte2<0)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),""]));if(byte1<224)utf16=64*(byte1-192)+byte2;else{var byte3=input[pos++]-128;if(byte3<0)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16)]));if(byte1<240)utf16=4096*(byte1-224)+64*byte2+byte3;else{var byte4=input[pos++]-128;if(byte4<0)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16),byte4.toString(16)]));if(byte1<248)utf16=262144*(byte1-240)+4096*byte2+64*byte3+byte4;else throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16),byte4.toString(16)]))}}}if(utf16>65535){utf16-=65536;output+=String.fromCharCode(55296+(utf16>>10));utf16=56320+(utf16&1023)}output+=String.fromCharCode(utf16)}return output}var Pinger=function(client,window,keepAliveInterval){this._client=client;this._window=window;this._keepAliveInterval=keepAliveInterval*1e3;this.isReset=false;var pingReq=new WireMessage(MESSAGE_TYPE.PINGREQ).encode();var doTimeout=function(pinger){return function(){return doPing.apply(pinger)}};var doPing=function(){if(!this.isReset){this._client._trace("Pinger.doPing","Timed out");this._client._disconnected(ERROR.PING_TIMEOUT.code,format(ERROR.PING_TIMEOUT))}else{this.isReset=false;this._client._trace("Pinger.doPing","send PINGREQ");this._client.socket.send(pingReq);this.timeout=this._window.setTimeout(doTimeout(this),this._keepAliveInterval)}};this.reset=function(){this.isReset=true;this._window.clearTimeout(this.timeout);if(this._keepAliveInterval>0)this.timeout=setTimeout(doTimeout(this),this._keepAliveInterval)};this.cancel=function(){this._window.clearTimeout(this.timeout)}};var Timeout=function(client,window,timeoutSeconds,action,args){this._window=window;if(!timeoutSeconds)timeoutSeconds=30;var doTimeout=function(action,client,args){return function(){return action.apply(client,args)}};this.timeout=setTimeout(doTimeout(action,client,args),timeoutSeconds*1e3);this.cancel=function(){this._window.clearTimeout(this.timeout)}};var ClientImpl=function(uri,host,port,path,clientId){if(!("WebSocket"in global&&global["WebSocket"]!==null)){throw new Error(format(ERROR.UNSUPPORTED,["WebSocket"]))}if(!("localStorage"in global&&global["localStorage"]!==null)){throw new Error(format(ERROR.UNSUPPORTED,["localStorage"]))}if(!("ArrayBuffer"in global&&global["ArrayBuffer"]!==null)){throw new Error(format(ERROR.UNSUPPORTED,["ArrayBuffer"]))}this._trace("Paho.MQTT.Client",uri,host,port,path,clientId);this.host=host;this.port=port;this.path=path;this.uri=uri;this.clientId=clientId;this._localKey=host+":"+port+(path!="/mqtt"?":"+path:"")+":"+clientId+":";this._msg_queue=[];this._sentMessages={};this._receivedMessages={};this._notify_msg_sent={};this._message_identifier=1;this._sequence=0;for(var key in localStorage)if(key.indexOf("Sent:"+this._localKey)==0||key.indexOf("Received:"+this._localKey)==0)this.restore(key)};ClientImpl.prototype.host;ClientImpl.prototype.port;ClientImpl.prototype.path;ClientImpl.prototype.uri;ClientImpl.prototype.clientId;ClientImpl.prototype.socket;ClientImpl.prototype.connected=false;ClientImpl.prototype.maxMessageIdentifier=65536;ClientImpl.prototype.connectOptions;ClientImpl.prototype.hostIndex;ClientImpl.prototype.onConnectionLost;ClientImpl.prototype.onMessageDelivered;ClientImpl.prototype.onMessageArrived;ClientImpl.prototype.traceFunction;ClientImpl.prototype._msg_queue=null;ClientImpl.prototype._connectTimeout;ClientImpl.prototype.sendPinger=null;ClientImpl.prototype.receivePinger=null;ClientImpl.prototype.receiveBuffer=null;ClientImpl.prototype._traceBuffer=null;ClientImpl.prototype._MAX_TRACE_ENTRIES=100;ClientImpl.prototype.connect=function(connectOptions){var connectOptionsMasked=this._traceMask(connectOptions,"password");this._trace("Client.connect",connectOptionsMasked,this.socket,this.connected);if(this.connected)throw new Error(format(ERROR.INVALID_STATE,["already connected"]));if(this.socket)throw new Error(format(ERROR.INVALID_STATE,["already connected"]));this.connectOptions=connectOptions;if(connectOptions.uris){this.hostIndex=0;this._doConnect(connectOptions.uris[0])}else{this._doConnect(this.uri)}};ClientImpl.prototype.subscribe=function(filter,subscribeOptions){this._trace("Client.subscribe",filter,subscribeOptions);if(!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));var wireMessage=new WireMessage(MESSAGE_TYPE.SUBSCRIBE);wireMessage.topics=[filter];if(subscribeOptions.qos!=undefined)wireMessage.requestedQos=[subscribeOptions.qos];else wireMessage.requestedQos=[0];if(subscribeOptions.onSuccess){wireMessage.onSuccess=function(grantedQos){subscribeOptions.onSuccess({invocationContext:subscribeOptions.invocationContext,grantedQos:grantedQos})}}if(subscribeOptions.onFailure){wireMessage.onFailure=function(errorCode){subscribeOptions.onFailure({invocationContext:subscribeOptions.invocationContext,errorCode:errorCode})}}if(subscribeOptions.timeout){wireMessage.timeOut=new Timeout(this,window,subscribeOptions.timeout,subscribeOptions.onFailure,[{invocationContext:subscribeOptions.invocationContext,errorCode:ERROR.SUBSCRIBE_TIMEOUT.code,errorMessage:format(ERROR.SUBSCRIBE_TIMEOUT)}])}this._requires_ack(wireMessage);this._schedule_message(wireMessage)};ClientImpl.prototype.unsubscribe=function(filter,unsubscribeOptions){this._trace("Client.unsubscribe",filter,unsubscribeOptions);if(!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));var wireMessage=new WireMessage(MESSAGE_TYPE.UNSUBSCRIBE);wireMessage.topics=[filter];if(unsubscribeOptions.onSuccess){wireMessage.callback=function(){unsubscribeOptions.onSuccess({invocationContext:unsubscribeOptions.invocationContext})}}if(unsubscribeOptions.timeout){wireMessage.timeOut=new Timeout(this,window,unsubscribeOptions.timeout,unsubscribeOptions.onFailure,[{invocationContext:unsubscribeOptions.invocationContext,errorCode:ERROR.UNSUBSCRIBE_TIMEOUT.code,errorMessage:format(ERROR.UNSUBSCRIBE_TIMEOUT)}])}this._requires_ack(wireMessage);this._schedule_message(wireMessage)};ClientImpl.prototype.send=function(message){this._trace("Client.send",message);if(!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));wireMessage=new WireMessage(MESSAGE_TYPE.PUBLISH);wireMessage.payloadMessage=message;if(message.qos>0)this._requires_ack(wireMessage);else if(this.onMessageDelivered)this._notify_msg_sent[wireMessage]=this.onMessageDelivered(wireMessage.payloadMessage);this._schedule_message(wireMessage)};ClientImpl.prototype.disconnect=function(){this._trace("Client.disconnect");if(!this.socket)throw new Error(format(ERROR.INVALID_STATE,["not connecting or connected"]));wireMessage=new WireMessage(MESSAGE_TYPE.DISCONNECT);this._notify_msg_sent[wireMessage]=scope(this._disconnected,this);this._schedule_message(wireMessage)};ClientImpl.prototype.getTraceLog=function(){if(this._traceBuffer!==null){this._trace("Client.getTraceLog",new Date);this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var key in this._sentMessages)this._trace("_sentMessages ",key,this._sentMessages[key]);for(var key in this._receivedMessages)this._trace("_receivedMessages ",key,this._receivedMessages[key]);return this._traceBuffer}};ClientImpl.prototype.startTrace=function(){if(this._traceBuffer===null){this._traceBuffer=[]}this._trace("Client.startTrace",new Date,version)};ClientImpl.prototype.stopTrace=function(){delete this._traceBuffer};ClientImpl.prototype._doConnect=function(wsurl){if(this.connectOptions.useSSL){var uriParts=wsurl.split(":");uriParts[0]="wss";wsurl=uriParts.join(":")}this.connected=false;if(this.connectOptions.mqttVersion<4){this.socket=new WebSocket(wsurl,["mqttv3.1"])}else{this.socket=new WebSocket(wsurl,["mqtt"])}this.socket.binaryType="arraybuffer";this.socket.onopen=scope(this._on_socket_open,this);this.socket.onmessage=scope(this._on_socket_message,this);this.socket.onerror=scope(this._on_socket_error,this);this.socket.onclose=scope(this._on_socket_close,this);this.sendPinger=new Pinger(this,window,this.connectOptions.keepAliveInterval);this.receivePinger=new Pinger(this,window,this.connectOptions.keepAliveInterval);this._connectTimeout=new Timeout(this,window,this.connectOptions.timeout,this._disconnected,[ERROR.CONNECT_TIMEOUT.code,format(ERROR.CONNECT_TIMEOUT)])};ClientImpl.prototype._schedule_message=function(message){this._msg_queue.push(message);if(this.connected){this._process_queue()}};ClientImpl.prototype.store=function(prefix,wireMessage){var storedMessage={type:wireMessage.type,messageIdentifier:wireMessage.messageIdentifier,version:1};switch(wireMessage.type){case MESSAGE_TYPE.PUBLISH:if(wireMessage.pubRecReceived)storedMessage.pubRecReceived=true;storedMessage.payloadMessage={};var hex="";var messageBytes=wireMessage.payloadMessage.payloadBytes;for(var i=0;i<messageBytes.length;i++){if(messageBytes[i]<=15)hex=hex+"0"+messageBytes[i].toString(16);else hex=hex+messageBytes[i].toString(16)}storedMessage.payloadMessage.payloadHex=hex;storedMessage.payloadMessage.qos=wireMessage.payloadMessage.qos;storedMessage.payloadMessage.destinationName=wireMessage.payloadMessage.destinationName;if(wireMessage.payloadMessage.duplicate)storedMessage.payloadMessage.duplicate=true;if(wireMessage.payloadMessage.retained)storedMessage.payloadMessage.retained=true;if(prefix.indexOf("Sent:")==0){if(wireMessage.sequence===undefined)wireMessage.sequence=++this._sequence;storedMessage.sequence=wireMessage.sequence}break;default:throw Error(format(ERROR.INVALID_STORED_DATA,[key,storedMessage]))}localStorage.setItem(prefix+this._localKey+wireMessage.messageIdentifier,JSON.stringify(storedMessage))};ClientImpl.prototype.restore=function(key){var value=localStorage.getItem(key);var storedMessage=JSON.parse(value);var wireMessage=new WireMessage(storedMessage.type,storedMessage);switch(storedMessage.type){case MESSAGE_TYPE.PUBLISH:var hex=storedMessage.payloadMessage.payloadHex;var buffer=new ArrayBuffer(hex.length/2);var byteStream=new Uint8Array(buffer);var i=0;while(hex.length>=2){var x=parseInt(hex.substring(0,2),16);hex=hex.substring(2,hex.length);byteStream[i++]=x}var payloadMessage=new Paho.MQTT.Message(byteStream);payloadMessage.qos=storedMessage.payloadMessage.qos;payloadMessage.destinationName=storedMessage.payloadMessage.destinationName;if(storedMessage.payloadMessage.duplicate)payloadMessage.duplicate=true;if(storedMessage.payloadMessage.retained)payloadMessage.retained=true;wireMessage.payloadMessage=payloadMessage;break;default:throw Error(format(ERROR.INVALID_STORED_DATA,[key,value]))}if(key.indexOf("Sent:"+this._localKey)==0){wireMessage.payloadMessage.duplicate=true;this._sentMessages[wireMessage.messageIdentifier]=wireMessage}else if(key.indexOf("Received:"+this._localKey)==0){this._receivedMessages[wireMessage.messageIdentifier]=wireMessage}};ClientImpl.prototype._process_queue=function(){var message=null;var fifo=this._msg_queue.reverse();while(message=fifo.pop()){this._socket_send(message);if(this._notify_msg_sent[message]){this._notify_msg_sent[message]();delete this._notify_msg_sent[message]}}};ClientImpl.prototype._requires_ack=function(wireMessage){var messageCount=Object.keys(this._sentMessages).length;if(messageCount>this.maxMessageIdentifier)throw Error("Too many messages:"+messageCount);while(this._sentMessages[this._message_identifier]!==undefined){this._message_identifier++}wireMessage.messageIdentifier=this._message_identifier;this._sentMessages[wireMessage.messageIdentifier]=wireMessage;if(wireMessage.type===MESSAGE_TYPE.PUBLISH){this.store("Sent:",wireMessage)}if(this._message_identifier===this.maxMessageIdentifier){this._message_identifier=1}};ClientImpl.prototype._on_socket_open=function(){var wireMessage=new WireMessage(MESSAGE_TYPE.CONNECT,this.connectOptions);wireMessage.clientId=this.clientId;this._socket_send(wireMessage)};ClientImpl.prototype._on_socket_message=function(event){this._trace("Client._on_socket_message",event.data);this.receivePinger.reset();var messages=this._deframeMessages(event.data);for(var i=0;i<messages.length;i+=1){this._handleMessage(messages[i])}};ClientImpl.prototype._deframeMessages=function(data){var byteArray=new Uint8Array(data);if(this.receiveBuffer){var newData=new Uint8Array(this.receiveBuffer.length+byteArray.length);newData.set(this.receiveBuffer);newData.set(byteArray,this.receiveBuffer.length);byteArray=newData;delete this.receiveBuffer}try{var offset=0;var messages=[];while(offset<byteArray.length){var result=decodeMessage(byteArray,offset);var wireMessage=result[0];offset=result[1];if(wireMessage!==null){messages.push(wireMessage)}else{break}}if(offset<byteArray.length){this.receiveBuffer=byteArray.subarray(offset)}}catch(error){this._disconnected(ERROR.INTERNAL_ERROR.code,format(ERROR.INTERNAL_ERROR,[error.message,error.stack.toString()]));return}return messages};ClientImpl.prototype._handleMessage=function(wireMessage){this._trace("Client._handleMessage",wireMessage);try{switch(wireMessage.type){case MESSAGE_TYPE.CONNACK:this._connectTimeout.cancel();if(this.connectOptions.cleanSession){for(var key in this._sentMessages){var sentMessage=this._sentMessages[key];localStorage.removeItem("Sent:"+this._localKey+sentMessage.messageIdentifier)}this._sentMessages={};for(var key in this._receivedMessages){var receivedMessage=this._receivedMessages[key];localStorage.removeItem("Received:"+this._localKey+receivedMessage.messageIdentifier)}this._receivedMessages={}}if(wireMessage.returnCode===0){this.connected=true;if(this.connectOptions.uris)this.hostIndex=this.connectOptions.uris.length}else{this._disconnected(ERROR.CONNACK_RETURNCODE.code,format(ERROR.CONNACK_RETURNCODE,[wireMessage.returnCode,CONNACK_RC[wireMessage.returnCode]]));break}var sequencedMessages=new Array;for(var msgId in this._sentMessages){if(this._sentMessages.hasOwnProperty(msgId))sequencedMessages.push(this._sentMessages[msgId])}var sequencedMessages=sequencedMessages.sort(function(a,b){return a.sequence-b.sequence});for(var i=0,len=sequencedMessages.length;i<len;i++){var sentMessage=sequencedMessages[i];if(sentMessage.type==MESSAGE_TYPE.PUBLISH&&sentMessage.pubRecReceived){var pubRelMessage=new WireMessage(MESSAGE_TYPE.PUBREL,{messageIdentifier:sentMessage.messageIdentifier});this._schedule_message(pubRelMessage)}else{this._schedule_message(sentMessage)}}if(this.connectOptions.onSuccess){this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext})}this._process_queue();break;case MESSAGE_TYPE.PUBLISH:this._receivePublish(wireMessage);break;case MESSAGE_TYPE.PUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){delete this._sentMessages[wireMessage.messageIdentifier];localStorage.removeItem("Sent:"+this._localKey+wireMessage.messageIdentifier);if(this.onMessageDelivered)this.onMessageDelivered(sentMessage.payloadMessage)}break;case MESSAGE_TYPE.PUBREC:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){sentMessage.pubRecReceived=true;var pubRelMessage=new WireMessage(MESSAGE_TYPE.PUBREL,{messageIdentifier:wireMessage.messageIdentifier});this.store("Sent:",sentMessage);this._schedule_message(pubRelMessage)}break;case MESSAGE_TYPE.PUBREL:var receivedMessage=this._receivedMessages[wireMessage.messageIdentifier];localStorage.removeItem("Received:"+this._localKey+wireMessage.messageIdentifier);if(receivedMessage){this._receiveMessage(receivedMessage);delete this._receivedMessages[wireMessage.messageIdentifier]}var pubCompMessage=new WireMessage(MESSAGE_TYPE.PUBCOMP,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubCompMessage);break;case MESSAGE_TYPE.PUBCOMP:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];delete this._sentMessages[wireMessage.messageIdentifier];localStorage.removeItem("Sent:"+this._localKey+wireMessage.messageIdentifier);if(this.onMessageDelivered)this.onMessageDelivered(sentMessage.payloadMessage);break;case MESSAGE_TYPE.SUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){if(sentMessage.timeOut)sentMessage.timeOut.cancel();wireMessage.returnCode.indexOf=Array.prototype.indexOf;if(wireMessage.returnCode.indexOf(128)!==-1){if(sentMessage.onFailure){sentMessage.onFailure(wireMessage.returnCode)}}else if(sentMessage.onSuccess){sentMessage.onSuccess(wireMessage.returnCode)}delete this._sentMessages[wireMessage.messageIdentifier]}break;case MESSAGE_TYPE.UNSUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){if(sentMessage.timeOut)sentMessage.timeOut.cancel();if(sentMessage.callback){sentMessage.callback()}delete this._sentMessages[wireMessage.messageIdentifier]}break;case MESSAGE_TYPE.PINGRESP:this.sendPinger.reset();break;case MESSAGE_TYPE.DISCONNECT:this._disconnected(ERROR.INVALID_MQTT_MESSAGE_TYPE.code,format(ERROR.INVALID_MQTT_MESSAGE_TYPE,[wireMessage.type]));break;default:this._disconnected(ERROR.INVALID_MQTT_MESSAGE_TYPE.code,format(ERROR.INVALID_MQTT_MESSAGE_TYPE,[wireMessage.type]))}}catch(error){this._disconnected(ERROR.INTERNAL_ERROR.code,format(ERROR.INTERNAL_ERROR,[error.message,error.stack.toString()]));return}};ClientImpl.prototype._on_socket_error=function(error){this._disconnected(ERROR.SOCKET_ERROR.code,format(ERROR.SOCKET_ERROR,[error.data]))};ClientImpl.prototype._on_socket_close=function(){this._disconnected(ERROR.SOCKET_CLOSE.code,format(ERROR.SOCKET_CLOSE))};ClientImpl.prototype._socket_send=function(wireMessage){if(wireMessage.type==1){var wireMessageMasked=this._traceMask(wireMessage,"password");this._trace("Client._socket_send",wireMessageMasked)}else this._trace("Client._socket_send",wireMessage);this.socket.send(wireMessage.encode());this.sendPinger.reset()};ClientImpl.prototype._receivePublish=function(wireMessage){switch(wireMessage.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(wireMessage);break;case 1:var pubAckMessage=new WireMessage(MESSAGE_TYPE.PUBACK,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubAckMessage);this._receiveMessage(wireMessage);break;case 2:this._receivedMessages[wireMessage.messageIdentifier]=wireMessage;this.store("Received:",wireMessage);var pubRecMessage=new WireMessage(MESSAGE_TYPE.PUBREC,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubRecMessage);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos)}};ClientImpl.prototype._receiveMessage=function(wireMessage){if(this.onMessageArrived){this.onMessageArrived(wireMessage.payloadMessage)}};ClientImpl.prototype._disconnected=function(errorCode,errorText){this._trace("Client._disconnected",errorCode,errorText);this.sendPinger.cancel();this.receivePinger.cancel();if(this._connectTimeout)this._connectTimeout.cancel();this._msg_queue=[];this._notify_msg_sent={};if(this.socket){this.socket.onopen=null;this.socket.onmessage=null;this.socket.onerror=null;this.socket.onclose=null;if(this.socket.readyState===1)this.socket.close();delete this.socket}if(this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1){this.hostIndex++;this._doConnect(this.connectOptions.uris[this.hostIndex])}else{if(errorCode===undefined){errorCode=ERROR.OK.code;errorText=format(ERROR.OK)}if(this.connected){this.connected=false;if(this.onConnectionLost)this.onConnectionLost({errorCode:errorCode,errorMessage:errorText})}else{if(this.connectOptions.mqttVersion===4&&this.connectOptions.mqttVersionExplicit===false){this._trace("Failed to connect V4, dropping back to V3");this.connectOptions.mqttVersion=3;if(this.connectOptions.uris){this.hostIndex=0;this._doConnect(this.connectOptions.uris[0])}else{this._doConnect(this.uri)}}else if(this.connectOptions.onFailure){this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:errorCode,errorMessage:errorText})}}}};ClientImpl.prototype._trace=function(){if(this.traceFunction){for(var i in arguments){if(typeof arguments[i]!=="undefined")arguments[i]=JSON.stringify(arguments[i])}var record=Array.prototype.slice.call(arguments).join("");this.traceFunction({severity:"Debug",message:record})}if(this._traceBuffer!==null){for(var i=0,max=arguments.length;i<max;i++){if(this._traceBuffer.length==this._MAX_TRACE_ENTRIES){this._traceBuffer.shift()}if(i===0)this._traceBuffer.push(arguments[i]);else if(typeof arguments[i]==="undefined")this._traceBuffer.push(arguments[i]);else this._traceBuffer.push("  "+JSON.stringify(arguments[i]))}}};ClientImpl.prototype._traceMask=function(traceObject,masked){var traceObjectMasked={};for(var attr in traceObject){if(traceObject.hasOwnProperty(attr)){if(attr==masked)traceObjectMasked[attr]="******";else traceObjectMasked[attr]=traceObject[attr]}}return traceObjectMasked};var Client=function(host,port,path,clientId){var uri;if(typeof host!=="string")throw new Error(format(ERROR.INVALID_TYPE,[typeof host,"host"]));if(arguments.length==2){clientId=port;uri=host;var match=uri.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(match){host=match[4]||match[2];port=parseInt(match[7]);path=match[8]}else{throw new Error(format(ERROR.INVALID_ARGUMENT,[host,"host"]))}}else{if(arguments.length==3){clientId=path;path="/mqtt"}if(typeof port!=="number"||port<0)throw new Error(format(ERROR.INVALID_TYPE,[typeof port,"port"]));if(typeof path!=="string")throw new Error(format(ERROR.INVALID_TYPE,[typeof path,"path"]));var ipv6AddSBracket=host.indexOf(":")!=-1&&host.slice(0,1)!="["&&host.slice(-1)!="]";uri="ws://"+(ipv6AddSBracket?"["+host+"]":host)+":"+port+path}var clientIdLength=0;for(var i=0;i<clientId.length;i++){var charCode=clientId.charCodeAt(i);if(55296<=charCode&&charCode<=56319){i++}clientIdLength++}if(typeof clientId!=="string"||clientIdLength>65535)throw new Error(format(ERROR.INVALID_ARGUMENT,[clientId,"clientId"]));var client=new ClientImpl(uri,host,port,path,clientId);this._getHost=function(){return host};this._setHost=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getPort=function(){return port};this._setPort=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getPath=function(){return path};this._setPath=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getURI=function(){return uri};this._setURI=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getClientId=function(){return client.clientId};this._setClientId=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getOnConnectionLost=function(){return client.onConnectionLost};this._setOnConnectionLost=function(newOnConnectionLost){if(typeof newOnConnectionLost==="function")client.onConnectionLost=newOnConnectionLost;else throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnConnectionLost,"onConnectionLost"]))};this._getOnMessageDelivered=function(){return client.onMessageDelivered};this._setOnMessageDelivered=function(newOnMessageDelivered){if(typeof newOnMessageDelivered==="function")client.onMessageDelivered=newOnMessageDelivered;else throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnMessageDelivered,"onMessageDelivered"]))};this._getOnMessageArrived=function(){return client.onMessageArrived};this._setOnMessageArrived=function(newOnMessageArrived){if(typeof newOnMessageArrived==="function")client.onMessageArrived=newOnMessageArrived;else throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnMessageArrived,"onMessageArrived"]))};this._getTrace=function(){return client.traceFunction};this._setTrace=function(trace){if(typeof trace==="function"){client.traceFunction=trace}else{throw new Error(format(ERROR.INVALID_TYPE,[typeof trace,"onTrace"]))}};this.connect=function(connectOptions){connectOptions=connectOptions||{};validate(connectOptions,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",mqttVersion:"number"});if(connectOptions.keepAliveInterval===undefined)connectOptions.keepAliveInterval=60;if(connectOptions.mqttVersion>4||connectOptions.mqttVersion<3){throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.mqttVersion,"connectOptions.mqttVersion"]))}if(connectOptions.mqttVersion===undefined){connectOptions.mqttVersionExplicit=false;connectOptions.mqttVersion=4}else{connectOptions.mqttVersionExplicit=true}if(connectOptions.password===undefined&&connectOptions.userName!==undefined)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.password,"connectOptions.password"]));if(connectOptions.willMessage){if(!(connectOptions.willMessage instanceof Message))throw new Error(format(ERROR.INVALID_TYPE,[connectOptions.willMessage,"connectOptions.willMessage"]));connectOptions.willMessage.stringPayload;if(typeof connectOptions.willMessage.destinationName==="undefined")throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.willMessage.destinationName,"connectOptions.willMessage.destinationName"]))}if(typeof connectOptions.cleanSession==="undefined")connectOptions.cleanSession=true;if(connectOptions.hosts){if(!(connectOptions.hosts instanceof Array))throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts,"connectOptions.hosts"]));if(connectOptions.hosts.length<1)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts,"connectOptions.hosts"]));var usingURIs=false;for(var i=0;i<connectOptions.hosts.length;i++){if(typeof connectOptions.hosts[i]!=="string")throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(connectOptions.hosts[i])){if(i==0){usingURIs=true}else if(!usingURIs){throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]))}}else if(usingURIs){throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]))}}if(!usingURIs){if(!connectOptions.ports)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));if(!(connectOptions.ports instanceof Array))throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));if(connectOptions.hosts.length!=connectOptions.ports.length)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));connectOptions.uris=[];for(var i=0;i<connectOptions.hosts.length;i++){if(typeof connectOptions.ports[i]!=="number"||connectOptions.ports[i]<0)throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.ports[i],"connectOptions.ports["+i+"]"]));var host=connectOptions.hosts[i];var port=connectOptions.ports[i];var ipv6=host.indexOf(":")!=-1;uri="ws://"+(ipv6?"["+host+"]":host)+":"+port+path;connectOptions.uris.push(uri)}}else{connectOptions.uris=connectOptions.hosts}}client.connect(connectOptions)};this.subscribe=function(filter,subscribeOptions){if(typeof filter!=="string")throw new Error("Invalid argument:"+filter);subscribeOptions=subscribeOptions||{};validate(subscribeOptions,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(subscribeOptions.timeout&&!subscribeOptions.onFailure)throw new Error("subscribeOptions.timeout specified with no onFailure callback.");if(typeof subscribeOptions.qos!=="undefined"&&!(subscribeOptions.qos===0||subscribeOptions.qos===1||subscribeOptions.qos===2))throw new Error(format(ERROR.INVALID_ARGUMENT,[subscribeOptions.qos,"subscribeOptions.qos"]));client.subscribe(filter,subscribeOptions)};this.unsubscribe=function(filter,unsubscribeOptions){if(typeof filter!=="string")throw new Error("Invalid argument:"+filter);unsubscribeOptions=unsubscribeOptions||{};validate(unsubscribeOptions,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(unsubscribeOptions.timeout&&!unsubscribeOptions.onFailure)throw new Error("unsubscribeOptions.timeout specified with no onFailure callback.");client.unsubscribe(filter,unsubscribeOptions)};this.send=function(topic,payload,qos,retained){var message;if(arguments.length==0){throw new Error("Invalid argument."+"length")}else if(arguments.length==1){if(!(topic instanceof Message)&&typeof topic!=="string")throw new Error("Invalid argument:"+typeof topic);message=topic;if(typeof message.destinationName==="undefined")throw new Error(format(ERROR.INVALID_ARGUMENT,[message.destinationName,"Message.destinationName"]));client.send(message)}else{message=new Message(payload);message.destinationName=topic;if(arguments.length>=3)message.qos=qos;if(arguments.length>=4)message.retained=retained;client.send(message)}};this.disconnect=function(){client.disconnect()};this.getTraceLog=function(){return client.getTraceLog()};this.startTrace=function(){client.startTrace()};this.stopTrace=function(){client.stopTrace()};this.isConnected=function(){return client.connected}};Client.prototype={get host(){return this._getHost()},set host(newHost){this._setHost(newHost)},get port(){return this._getPort()},set port(newPort){this._setPort(newPort)},get path(){return this._getPath()},set path(newPath){this._setPath(newPath)},get clientId(){return this._getClientId()},set clientId(newClientId){this._setClientId(newClientId)},get onConnectionLost(){return this._getOnConnectionLost()},set onConnectionLost(newOnConnectionLost){this._setOnConnectionLost(newOnConnectionLost)},get onMessageDelivered(){return this._getOnMessageDelivered()},set onMessageDelivered(newOnMessageDelivered){this._setOnMessageDelivered(newOnMessageDelivered)},get onMessageArrived(){return this._getOnMessageArrived()},set onMessageArrived(newOnMessageArrived){this._setOnMessageArrived(newOnMessageArrived)},get trace(){return this._getTrace()},set trace(newTraceFunction){this._setTrace(newTraceFunction)}};var Message=function(newPayload){var payload;if(typeof newPayload==="string"||newPayload instanceof ArrayBuffer||newPayload instanceof Int8Array||newPayload instanceof Uint8Array||newPayload instanceof Int16Array||newPayload instanceof Uint16Array||newPayload instanceof Int32Array||newPayload instanceof Uint32Array||newPayload instanceof Float32Array||newPayload instanceof Float64Array){payload=newPayload}else{throw format(ERROR.INVALID_ARGUMENT,[newPayload,"newPayload"])}this._getPayloadString=function(){if(typeof payload==="string")return payload;else return parseUTF8(payload,0,payload.length)};this._getPayloadBytes=function(){if(typeof payload==="string"){var buffer=new ArrayBuffer(UTF8Length(payload));var byteStream=new Uint8Array(buffer);stringToUTF8(payload,byteStream,0);return byteStream}else{return payload}};var destinationName=undefined;this._getDestinationName=function(){return destinationName};this._setDestinationName=function(newDestinationName){if(typeof newDestinationName==="string")destinationName=newDestinationName;else throw new Error(format(ERROR.INVALID_ARGUMENT,[newDestinationName,"newDestinationName"]))};var qos=0;this._getQos=function(){return qos};this._setQos=function(newQos){if(newQos===0||newQos===1||newQos===2)qos=newQos;else throw new Error("Invalid argument:"+newQos)};var retained=false;this._getRetained=function(){return retained};this._setRetained=function(newRetained){if(typeof newRetained==="boolean")retained=newRetained;else throw new Error(format(ERROR.INVALID_ARGUMENT,[newRetained,"newRetained"]))};var duplicate=false;this._getDuplicate=function(){return duplicate};this._setDuplicate=function(newDuplicate){duplicate=newDuplicate}};Message.prototype={get payloadString(){return this._getPayloadString()},get payloadBytes(){return this._getPayloadBytes()},get destinationName(){return this._getDestinationName()},set destinationName(newDestinationName){this._setDestinationName(newDestinationName)},get qos(){return this._getQos()},set qos(newQos){this._setQos(newQos)},get retained(){return this._getRetained()},set retained(newRetained){this._setRetained(newRetained)},get duplicate(){return this._getDuplicate()},set duplicate(newDuplicate){this._setDuplicate(newDuplicate)}};return{Client:Client,Message:Message}}(window);var mTb,mTv,m_option=true,searchMarker=null,_SI="0",gO,AJX,_URL="/",AURL="/w.ajx",IC="/mkr_files/icons",tIC=IC+"/tree/",mIC=IC+"/map/",a_sel,gL,t_hb=0,gCHO,gMap;var menu_data_multi=[{id:"m_0",value:"Dashboard",icon:"mdi mdi-tablet-dashboard"},{id:"mmap_id",icon:"mdi mdi-earth",value:"Stations on Map"},{id:"m_2",icon:"mdi mdi-file-chart",value:"Reports"},{id:"m_3",icon:"mdi mdi-ev-station",value:"Charging Stations"},{id:"m_4",icon:"mdi mdi-ev-station",value:"Set Charging Profile"},{id:"m_5",icon:"mdi mdi-ev-station",value:"Diagnostics"},{id:"m_9",icon:"mdi mdi-help-network",value:"Supported documents"},{id:"m_10",icon:"mdi mdi-logout",value:"Logout"}];function getMainUIs(){var cs_reports_ui=getCSReportsUI(),cs_profile_ui=getCSProfileUI(),cs_ocpp_ui=getCSOcppTestUI();getAllProfiles();var main_uis={rows:[{view:"toolbar",padding:3,elements:[{view:"icon",icon:"mdi mdi-menu",click:function(){$$("sb_id").toggle()}},{view:"label",id:"l_user_id",label:"*"},{},{view:"label",id:"l_sel_cs_id",label:""},{},{view:"icon",id:"msgs_btn_id",width:60,icon:"mdi mdi-chat",tooltip:"Chat with mobile workers",badge:12,popup:"msg_pop"}]},{cols:[{view:"sidebar",id:"sb_id",width:280,data:menu_data_multi,on:{onAfterSelect:function(id){if(id=="m_3"){if(!gCHO){gCHO=new CHSTATIONS(id)}}else if(id=="m_4"){getCsProfile()}else if(id=="m_10"){LO()}var v=$$("multi_id");v.setValue(id)}}},{view:"resizer"},{id:"multi_id",cells:[dashboard_charts,{id:"mmap_id",view:gMap.name},cs_reports_ui,{id:"m_3"},cs_profile_ui,cs_ocpp_ui,{id:"m_9",rows:[{},{view:"template",template:"<a target='_blank' alt='User guide' title='User guide'   href='uc_docs/GrizzlE_Smart_v10.pdf' > User guide</a>"},{},{view:"template",template:"<a target='_blank' alt='FW Uploader Handbook' title='User Manual Connection Guide'   href='uc_docs/user_manual_connection_guide.pdf' > User Manual Connection Guide</a>"},{}]}]}]}]};return main_uis}var gRes=null;function g_mw_list(cb,force){if(!force&&gRes!=null&&gRes.length>0){if(cb)cb();return}sendCommPReq(21,gL.cid,-1,gL.user,"*",function(buf){var o,p=new Pbf(buf);try{o=PEmplList.read(p)}catch(e){}if(o!=null){gRes=o.list;if(cb)cb()}})}function makeRes(id){var ar=[];for(var i=0;i<gRes.length;i++){var o=gRes[i],q,f=false;if(isNDef(id)){if(i==0)f=true}else if(o.ID==id)f=true;q={id:o.ID,name:o.DrName,photo:o.photo,selected:f};ar.push(q)}return ar}function getResInd(id){if(gRes!=null){for(var i=0;i<gRes.length;i++)if(gRes[i].ID==id)return i}return-1}function getResName(id){var i=getResInd(id);return i!=-1?gRes[i].DrName:""}function getRes(id){var i=getResInd(id);return i!=-1?gRes[i]:null}function getResTZ(did){var rid=getRID(did),r,tz=0;if(rid>0){r=getRes(rid);if(r){tz=r.TZ}}return tz}function getRID(did){var rid,x;try{x=did.split("-");rid=x[1]}catch(e){}if(isNDef(rid))rid=-1;return rid}function updateRLoc(o,loc){var rid=getRID(o.did),r;if(rid>0){r=getRes(rid);if(r){r.Loc=loc}}}function get_m_photo(o){var ph=o?o.photo:null;if(isEmpty(ph))ph="blank.png";ph="media/resImg/"+ph;return ph}function _mob_w_fn(o){var ph=get_m_photo(o);var cf="<img height='32' width='32' src='"+ph+"' style='float:left;'>";var h="<span style='margin-left:10px'>"+o.name+"</span>";return"<div>"+cf+h+"</div>"}function mob_w_fn(o){return _mob_w_fn(o)}function mob_ch_fn(o){return _mob_w_fn(o)}var gVL=null;function g_veh_list(cb,force){if(!force&&gVL!=null&&gVL.length>0){if(cb)cb();return}sendCommPReq(23,gL.cid,-1,gL.user,"*",function(buf){var o,p=new Pbf(buf);try{o=PVehicleList.read(p)}catch(e){}if(o!=null){gVL=o.vitem;if(cb)cb()}})}function g_veh_obj(id){for(var i=0;i<gVL.length;i++){var o=gVL[i];if(o.UID==id){return o}}return null}function getVehPhoto(id){var ph="";if(gVL)for(var i=0;i<gVL.length;i++){var o=gVL[i];if(o.UID==id){ph=o.Img;break}}if(isEmpty(ph))ph="blank.png";ph="media/v_img/"+ph;return ph}function gPrms(n){return"req="+n+"&cid="+gL.cid+"&user="+gL.user+"&_si="+_SI+"&rnd="+g_rand()}function LO(){window.location="index.html"}function onLoad(){t_hb=Date.now()}function onload_template_cb(buf){var p=new Pbf(buf);var o=CLogin.read(p);if(o!=null&&o.res==2){var elm=_el("m_content");elm.innerHTML=o.pass;_onready()}else LO()}function onload_response_cb(buf){try{var p=new Pbf(buf);var o=CLogin.read(p);if(o!=null&&o.res==2){gL=o;window.onbeforeunload=function(){unloadA()};sendCommPReq(3,o.cid,-1,o.user,"*",onload_template_cb)}else LO()}catch(e){LO()}}function _onload(){var elm=_el("m_si");var si=elm.innerHTML;sendCommPReq(2,-1,-1,si,"*",onload_response_cb)}function unloadA(){sendCommPReq(8,gL.cid,-1,gL.user,"*",function(b){var v=b})}function unLoad(){}function gmap_init_done(){}function _onready(){gMap=new MkrGMap("mikerel-map",gmap_init_done,1);mkrwa.protoUI(gMap,mkrwa.ui.view);mkrwa.ui(getMainUIs());setLbl("l_user_id",gL.user+" : "+gL.cid);$$("sb_id").select("m_3");window.setTimeout(m_timer,3e3);fakeDBData();fakeProfChartData();mkrwa.ui({view:"popup",id:"msg_pop",head:"",point:true,width:500,height:600,body:chat_body});init_chat()}function setLbl(id,v){var x=$$(id);x.define("label",v);x.refresh()}function updateNMsgs(n){var x=$$("msgs_btn_id");x.define("badge",n);x.refresh()}function dbg(str){console.log(str)}mkrwa.ready(function(){AJX=mkrwa.ajax();_onload()});function m_timer_cb(buf){var s=ba2Str(buf);if(s){var rtt=JSON.parse(s);if(rtt){if(gCHO)gCHO.updateCSSts(rtt.ChSs)}}}function m_timer(){var ChSs="GRS-4011000010|SIM-4111000010";sendCommPReq(66,gL.cid,-1,gL.user,ChSs,m_timer_cb);window.setTimeout(m_timer,3e3)}function tb_conf_fn(){{mkrwa.alert({ok:"OK",type:"alert-warning",text:"Please select a device first"})}}var webSocket=null;function open_ws(u){u="ws://localhost:9002";webSocket=new WebSocket(u);webSocket.onopen=function(event){console.log("on open.."+webSocket.url)};webSocket.onmessage=function(event){console.log(event.data)};webSocket.onerror=function(error){console.error("WebSocket error observed:",error)};webSocket.onclose=function(event){console.log("WebSocket is closed now.")}}function close_ws(){webSocket.close();webSocket=null}function sendText(){var msg={type:"message",text:"text_2_send",id:"clientID",date:Date.now()};var s1=JSON.stringify(msg);webSocket.send(s1)}mkrwa.DataDriver.legacy=mkrwa.extend({records:"/*/row",tagToObject:function(tag,z){if(tag.tagName=="row"){tag.setAttribute("stack","1");return{cell:mkrwa.DataDriver.xml.tagToObject(tag,z)}}return mkrwa.DataDriver.xml.tagToObject(tag,z)}},mkrwa.DataDriver.xml);Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.toDeg=function(){return this*180/Math.PI};function guid(){function _p8(s){var p=(Math.random().toString(16)+"000000000").substr(2,8);return s?"-"+p.substr(0,4)+"-"+p.substr(4,4):p}return _p8()+_p8(true)+_p8(true)+_p8()}var dateFormat=function(){var token=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,timezone=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,timezoneClip=/[^-+\dA-Z]/g,pad=function(val,len){val=String(val);len=len||2;while(val.length<len)val="0"+val;return val};return function(date,mask,utc){var dF=dateFormat;if(arguments.length==1&&Object.prototype.toString.call(date)=="[object String]"&&!/\d/.test(date)){mask=date;date=undefined}date=date?new Date(date):new Date;if(isNaN(date))throw SyntaxError("invalid date");mask=String(dF.masks[mask]||mask||dF.masks["default"]);if(mask.slice(0,4)=="UTC:"){mask=mask.slice(4);utc=true}var _=utc?"getUTC":"get",d=date[_+"Date"](),D=date[_+"Day"](),m=date[_+"Month"](),y=date[_+"FullYear"](),H=date[_+"Hours"](),M=date[_+"Minutes"](),s=date[_+"Seconds"](),L=date[_+"Milliseconds"](),o=utc?0:date.getTimezoneOffset(),flags={d:d,dd:pad(d),ddd:dF.i18n.dayNames[D],dddd:dF.i18n.dayNames[D+7],m:m+1,mm:pad(m+1),mmm:dF.i18n.monthNames[m],mmmm:dF.i18n.monthNames[m+12],yy:String(y).slice(2),yyyy:y,h:H%12||12,hh:pad(H%12||12),H:H,HH:pad(H),M:M,MM:pad(M),s:s,ss:pad(s),l:pad(L,3),L:pad(L>99?Math.round(L/10):L),t:H<12?"a":"p",tt:H<12?"am":"pm",T:H<12?"A":"P",TT:H<12?"AM":"PM",Z:utc?"UTC":(String(date).match(timezone)||[""]).pop().replace(timezoneClip,""),o:(o>0?"-":"+")+pad(Math.floor(Math.abs(o)/60)*100+Math.abs(o)%60,4),S:["th","st","nd","rd"][d%10>3?0:(d%100-d%10!=10)*d%10]};return mask.replace(token,function($0){return $0 in flags?flags[$0]:$0.slice(1,$0.length-1)})}}();dateFormat.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(mask,utc){return dateFormat(this,mask,utc)};if(!Date.prototype.toISOString){(function(){function pad(number){if(number<10){return"0"+number}return number}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+pad(this.getUTCMonth()+1)+"-"+pad(this.getUTCDate())+"T"+pad(this.getUTCHours())+":"+pad(this.getUTCMinutes())+":"+pad(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}})()}function pad(number){if(number<10){return"0"+number}return number}function mtoISOString(_this){return _this.getFullYear()+"-"+pad(_this.getMonth()+1)+"-"+pad(_this.getDate())+"T"+pad(_this.getHours())+":"+pad(_this.getMinutes())+":"+pad(_this.getSeconds())+"."+(_this.getMilliseconds()/1e3).toFixed(3).slice(2,5)}function ts2D(s){var d;if(typeof s=="string"){d=ISOStr2Date(s)}else{d=new Date(s)}return d}function toDateStr(s,f){var d=ts2D(s),r;if(f)r=d.format("mmm d, yyyy HH:MM",true);else r=d.format("mmm d, yyyy",true);return r}function toResDateStr(ts,did){var tz=getResTZ(did);ts=correct2TZ(ts,tz);var d=new Date(ts);return d.format("mmm d, yyyy HH:MM",true)}function ISOStr2Date(str){return new Date(str)}function dtMillis(v){var x=new Date(v);var m=x.getMonth()+1,d=x.getDate(),h=x.getHours(),n=x.getMinutes(),s=x.getSeconds();m=(m<10?"0":"")+m;d=(d<10?"0":"")+d;h=(h<10?"0":"")+h;n=(n<10?"0":"")+n;s=(s<10?"0":"")+s;return x.getFullYear()+"-"+m+"-"+d+" "+h+":"+n+":"+s}function correct2TZ(ts,tz){if(tz>0){var tz1=tz&65535;if(tz1>32767){tz1=tz1-65536}var dls=tz>>16;ts+=tz1*3600*1e3}return ts}function getDateTimeNow(tz){var ts=Date.now();return correct2TZ(ts,tz)}function _getDT(){var d=new Date;var ts=Date.now();var n=d.getTimezoneOffset();ts=ts-n*60*1e3;d=new Date(ts);return d}function getShortTime(){var d=_getDT();r=d.format("h:MM:ss TT",true);return r}function getLongTime(){var d=_getDT();r=d.format("mmm d, yyyy HH:MM",true);return r}function str2date(s){var s1=s.split(" ");var d=s1[0].split("/");var t=s1[1].split(":");var h=parseInt(t[0]);if(s.indexOf("PM")!=-1)h+=12;var date=new Date(d[2],d[0]-1,d[1],h,t[1]);return date}function getMidNightMillis(ts){var x=ts%(24*3600*1e3);x=ts-x;return x}function IsTheSameDate(ts1,ts2){return getMidNightMillis(ts1)==getMidNightMillis(ts2)}function to_string(n){var s=n+"";if(s.length==1)s="0"+s;return s}function m_round(value,precision){var multiplier=Math.pow(10,precision||0);return Math.round(value*multiplier)/multiplier}function ConvertMinutesToHoursandMinutes(v){var m,h=Math.floor(v/60);m=m_round(v%60);var s=to_string(h)+":"+to_string(m);return s}function getDist(d){d=d/1e3;return m_round(d,2)+" km"}function g_rand(){return Math.round(Math.random()*1e4)}function loadJsCss(fn,ft){var fref;if(ft=="js"){fref=document.createElement("script");fref.setAttribute("type","text/javascript");fref.setAttribute("src",fn)}else if(ft=="css"){fref=document.createElement("link");fref.setAttribute("rel","stylesheet");fref.setAttribute("type","text/css");fref.setAttribute("href",fn)}if(typeof fref!="undefined")document.getElementsByTagName("head")[0].appendChild(fref)}function cancelBubble(e){var evt=e?e:window.event;if(evt.stopPropagation)evt.stopPropagation();if(evt.cancelBubble!=null)evt.cancelBubble=true}function isNDef(a){return typeof a=="undefined"||a==null}function isEmpty(a){return isNDef(a)||a==""}function _el(v){return document.getElementById(v)}function str2int(s){return parseInt(s)}function c_str(s,sb){var rv=false;if(s.toLowerCase().indexOf(sb)!=-1)rv=true;return rv}function cStr(s,sb){var s1=sb.split(" ");if(s1.length>1){for(var i in s1){if(!c_str(s,s1[i]))return false}return true}else return c_str(s,sb)}String.prototype.replaceAll=function(str1,str2,ignore){return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),ignore?"gi":"g"),typeof str2=="string"?str2.replace(/\$/g,"$$$$"):str2)};function GenerateUID(did){var d=Date.now();var rv=did+"-"+d;return rv}function int2Str(d){return String.fromCharCode(d)}function color2Int(s){return(parseInt(s.substr(1),16)<<8)/256}function rgbToHex(rgb){var hex=Number(rgb).toString(16);if(hex.length<2){hex="0"+hex}return hex}function toColor(num){num>>>=0;var b=num&255,g=(num&65280)>>>8,r=(num&16711680)>>>16,a=((num&4278190080)>>>24)/255;return"#"+rgbToHex(r)+rgbToHex(g)+rgbToHex(b)}function Int2Color(number){return toColor(number)}var metersPerPixel=function(latitude,zoomLevel){var earthCircumference=40075017;var latitudeRadians=latitude*(Math.PI/180);return earthCircumference*Math.cos(latitudeRadians)/Math.pow(2,zoomLevel+8)};function pixelValue(latitude,meters,zoomLevel){return meters/metersPerPixel(latitude,zoomLevel)}var BASE64_MARKER=";base64,";function convertDataURIToBinary(dataURI){var base64Index=dataURI.indexOf(BASE64_MARKER)+BASE64_MARKER.length;var base64=dataURI.substring(base64Index);var raw=window.atob(base64);var rawLength=raw.length;var array=new Uint8Array(new ArrayBuffer(rawLength));for(i=0;i<rawLength;i++){array[i]=raw.charCodeAt(i)}return array}var upl_file_name="";function do_upload_file(arr,req,fname){try{var pbf=new Pbf;var rq=isNDef(req)?14:req;var fn=isNDef(fname)?upl_file_name:fname;var comm=createCommP(pbf,rq,gL.cid,arr.length,fn);comm.payload=arr;CommPacket.write(comm,pbf);var buffer=pbf.finish();sendBAPost(_url_,buffer,function(buf){var s=ba2Str(buf);if(s.indexOf("OK")==-1)alert(s)})}catch(e){alert(e)}}function previewFile(id){var file=document.querySelector("input[type=file]").files[0];var R=new FileReader;upl_file_name=file.name;R.addEventListener("load",function(){_el(id.id).src=R.result;var arr=convertDataURIToBinary(R.result);do_upload_file(arr)},false);if(file){R.readAsDataURL(file)}}